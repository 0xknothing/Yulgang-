<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ygLight Bot - Yulgang Simulation v14</title>
    <style>
        /* --- Core Styles & Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Tahoma:wght@400;700&display=swap');
        :root { --main-bg: #f0f0f0; --border-out-top-left: #fff; --border-out-bottom-right: #808080; --border-in-top-left: #808080; --border-in-bottom-right: #fff; --inactive-tab-bg: #d4d0c8; }
        * { box-sizing: border-box; user-select: none; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: 'Tahoma', sans-serif; font-size: 11px; background: #3a6ea5; padding: 2px; color: #000; }

        /* --- Window Styles --- */
        .main-window { width: 100%; max-width: 800px; height: 100%; max-height: 600px; background: var(--main-bg); border: 1px solid #0831d9; box-shadow: 1px 1px 5px rgba(0,0,0,0.5); display: flex; flex-direction: column; margin: auto; }
        .title-bar { background: linear-gradient(to bottom, #005cda, #004ba9); color: white; padding: 3px 5px; font-weight: bold; display: flex; align-items: center; height: 22px; cursor: default; flex-shrink: 0; }
        .title-bar-text { flex-grow: 1; }
        .title-bar-icon { width: 16px; height: 16px; margin-right: 4px; display: flex; align-items: center; justify-content: center; font-size: 14px;}
        .window-controls button { width: 18px; height: 16px; border: 1px outset var(--border-out-top-left); background: var(--inactive-tab-bg); font-family: 'Marlett', 'Webdings'; font-size: 10px; margin-left: 2px; line-height: 12px; text-align: center; }
        .menu-bar { background: var(--inactive-tab-bg); border-bottom: 1px solid var(--border-out-bottom-right); padding: 2px 4px; display: flex; gap: 8px; flex-shrink: 0; }
        .status-bar { border-top: 1px solid var(--border-out-top-left); padding: 2px 4px; font-size: 10px; display: flex; justify-content: space-between; flex-shrink: 0; flex-wrap: wrap; }
        .status-bar-panel { border: 1px inset var(--border-in-top-left); padding: 0 5px; margin-top: 2px; }
        
        /* --- Panel & Layout Styles --- */
        .content-area { display: flex; flex-grow: 1; padding: 2px; overflow: hidden; }
        .panel { border: 1px solid; border-color: var(--border-in-top-left) var(--border-out-top-left) var(--border-out-top-left) var(--border-in-top-left); background: var(--main-bg); padding: 1px; }
        .panel-inset { border: 1px solid; border-color: var(--border-in-top-left) var(--border-out-top-left) var(--border-out-top-left) var(--border-in-top-left); box-shadow: inset 1px 1px 0 #c0c0c0; }
        .group-box { border: 1px solid var(--border-in-top-left); padding: 10px 5px 5px 5px; margin: 5px; position: relative; }
        .group-box-title { position: absolute; top: -7px; left: 8px; background: var(--main-bg); padding: 0 4px; }
        .left-panel { width: 60%; display: flex; flex-direction: column; padding-right: 2px; }
        .right-panel { width: 40%; display: flex; flex-direction: column; }
        .right-panel .panel { background: linear-gradient(135deg, #d3c4b3 0%, #b49a7f 100%); } /* Texture background */
        .right-panel .group-box-title { background: #dfd1c3; } /* Match texture */
        .right-panel .tab-button.active { background: transparent; border-bottom: 1px solid transparent; }

        /* --- Tab Control Styles --- */
        .tab-bar { display: flex; flex-wrap: nowrap; overflow-x: auto; border-bottom: 1px solid var(--border-in-top-left); padding-left: 3px; height: 21px; }
        .tab-button { white-space: nowrap; padding: 3px 8px; border: 1px solid; border-color: var(--border-out-top-left) var(--border-in-top-left) var(--border-in-top-left) var(--border-out-top-left); border-bottom: none; background: var(--inactive-tab-bg); position: relative; top: 1px; margin-right: 1px; cursor: pointer; }
        .tab-button.active { background: var(--main-bg); border-bottom: 1px solid var(--main-bg); font-weight: bold; }
        .tab-content { display: none; height: 100%; overflow-y: auto; }
        .tab-content.active { display: block; }

        /* --- Main App UI Elements --- */
        .top-bar { padding: 3px; display: grid; grid-template-columns: 1fr 1fr; grid-gap: 5px; border-bottom: 1px solid #c0c0c0; }
        .top-bar-section { display: flex; align-items: center; }
        .top-bar-section label { white-space: nowrap; margin-right: 4px; }
        .top-bar-section select, .top-bar-section input { flex-grow: 1; width: 100px; }
        .top-bar-stats { display: flex; align-items: center; gap: 8px; margin-top: 4px; flex-wrap: wrap; }
        .map-view { height: 250px; background: url(https://static.wikia.nocookie.net/sof/images/0/0b/Central_Valley.png) center/contain no-repeat; position: relative; background-color: #1a2d1a; }
        #player-dot {
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 12px solid #FFFF00;
            position: absolute;
            transform: translate(-50%, -50%);
            transition: all 0.5s linear;
            filter: drop-shadow(0px 0px 2px rgba(0, 0, 0, 0.7));
        }
        .map-controls { padding: 4px; display: flex; justify-content: flex-start; align-items: center; gap: 10px; background: var(--inactive-tab-bg); flex-wrap: wrap; }
        .map-controls label { margin-left: 5px;}
        .zoom-slider { flex-grow: 1; margin: 0 10px; }
        .log-panel, .environment-panel { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .log-area, .env-area { flex-grow: 1; background: white; border: 1px inset var(--border-in-top-left); padding: 3px; font-family: 'Courier New', monospace; font-size: 10px; overflow-y: scroll; }
        #logArea { background-color: black; color: white; }
        .log-system { color: #00FF00; } .log-exp { color: #FFFF00; } .log-attack { color: #FF4757; } .log-item { color: #26DE81; } .log-error { color: #FF0000; } .log-info { color: #87CEEB; } .log-skill { color: #f088f8; } .log-quest { color: #99ff99; }
        .info-tabs .tab-content { padding: 5px; }
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 2px 8px; }
        .stat-item { display: flex; justify-content: space-between; }
        .progress-bar { height: 12px; background: #c0c0c0; border: 1px inset var(--border-in-top-left); position: relative; flex-grow: 1; }
        .progress-fill { height: 100%; position: absolute; left:0; top:0; }
        .hp-fill { background: red; } .mp-fill { background: blue; } .exp-fill { background: #ffa500; } .rage-fill { background: green; }
        .buff-bar { display: flex; gap: 4px; margin-top: 5px; padding: 2px 5px; min-height: 26px;}
        .buff-icon { width: 20px; height: 20px; background-color: #ccc; border: 1px solid #888; font-size: 14px; text-align: center; line-height: 18px; position: relative; }
        .buff-icon .tooltip { visibility: hidden; width: 120px; background-color: black; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -60px; opacity: 0; transition: opacity 0.3s; }
        .buff-icon:hover .tooltip { visibility: visible; opacity: 1; }
        
        /* --- General Controls --- */
        input, select, button { font-family: 'Tahoma', sans-serif; font-size: 11px; border: 1px solid; border-color: var(--border-in-top-left) var(--border-out-top-left) var(--border-out-top-left) var(--border-in-top-left); padding: 2px 4px; }
        button { background: var(--inactive-tab-bg); border-color: var(--border-out-top-left) var(--border-in-top-left) var(--border-in-top-left) var(--border-out-top-left); min-width: 70px; cursor: pointer; }
        button:active { border-color: var(--border-in-top-left) var(--border-out-top-left) var(--border-out-top-left) var(--border-in-top-left); }
        .table-list { width: 100%; border-collapse: collapse; }
        .table-list th, .table-list td { border: 1px solid #c0c0c0; padding: 2px 4px; text-align: left; }
        .table-list th { background: var(--inactive-tab-bg); }
        .env-area .targeted { background-color: #ffecb3; }
        .env-area .clickable:hover { background-color: #e3f2fd; cursor: pointer; }

        /* --- Dialog & Shop Windows --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .dialog-window { width: 90%; max-width: 350px; background: var(--main-bg); border: 1px solid #0831d9; box-shadow: 2px 2px 8px rgba(0,0,0,0.6); display: flex; flex-direction: column; }
        .dialog-title-bar { background: linear-gradient(to bottom, #005cda, #004ba9); color: white; padding: 3px 5px; font-weight: bold; }
        .dialog-content { padding: 15px; font-size: 12px; line-height: 1.5; }
        .dialog-buttons { padding: 8px; text-align: right; background: var(--inactive-tab-bg); border-top: 1px solid var(--border-in-top-left); }
        .dialog-buttons button { margin-left: 5px; }
        
        /* --- Control Tab --- */
        .control-setting { margin-bottom: 8px; }
        .control-setting label { display: inline-block; width: 120px; }
        .control-setting input[type=number] { width: 50px; }
        #buff-settings-container label { display: block; margin-bottom: 4px; }

        /* --- Responsive Design for Mobile --- */
        @media (max-width: 768px) {
            html, body {
                height: auto; 
                overflow: auto;
            }
            .main-window {
                height: auto;
                min-height: 100vh;
                max-height: none;
                margin: 0;
                border: none;
            }
            .content-area {
                flex-direction: column;
                overflow: visible;
            }
            .left-panel, .right-panel {
                width: 100%;
                padding-right: 0;
            }
            .right-panel {
                flex-grow: 1;
            }
            .top-bar {
                grid-template-columns: 1fr;
            }
        }

    </style>
</head>
<body>

<div class="main-window">
    <div class="title-bar"><div class="title-bar-icon">🎮</div><span class="title-bar-text">ygLight Bot</span><div class="window-controls"><button>0</button><button>1</button><button>r</button></div></div>
    <div class="menu-bar"><span>File</span><span>Options</span><span>Help</span></div>
    
    <div id="app-screen" class="content-area">
        <div class="left-panel">
            <div class="panel">
                <div class="top-bar">
                    <div><div class="top-bar-section"><label for="server">เซิร์ฟเวอร์:</label><select id="server"><option>พิชิตสุริยัน</option></select></div><div class="top-bar-section"><label for="char-name">ชื่อ:</label><input type="text" id="char-name" value="ศิลปินเดี่ยว07" readonly></div></div>
                    <div><div class="top-bar-section"><label for="char-select">ตัวละคร:</label><select id="char-select"><option>1</option></select><label for="pass">รหัสผ่าน:</label><input type="password" id="pass" value="********" readonly></div><div class="top-bar-section"><button>Login</button><button>Logout</button></div></div>
                </div>
                <div class="top-bar-stats panel-inset">LV: <span id="stat-lv-top" style="margin-right:10px;">0</span> พลังชีวิต: <div class="progress-bar" style="width: 80px;"><div id="hp-bar-top" class="progress-fill hp-fill"></div></div><span id="hp-percent-top">0%</span> พลังปราณ: <div class="progress-bar" style="width: 80px;"><div id="mp-bar-top" class="progress-fill mp-fill"></div></div><span id="mp-percent-top">0%</span> ประสบการณ์: <div class="progress-bar" style="width: 80px;"><div id="exp-bar-top" class="progress-fill exp-fill"></div></div><span id="exp-percent-top">0%</span></div>
                <div class="buff-bar panel-inset" id="buff-bar-main"></div>
            </div>
            <div class="panel" style="flex-grow: 1; margin-top: 2px; display: flex; flex-direction: column;">
                <div class="tab-bar"><div class="tab-button active">แผนที่</div><div class="tab-button">สถานะ</div></div>
                <div class="tab-content active" style="flex-grow: 1; display:flex; flex-direction:column;">
                    <div class="map-view"><div id="player-dot"></div></div>
                    <div class="map-controls">
                        <span>Zoom:</span> <input type="range" min="1" max="100" value="50" class="zoom-slider">
                        <label><input type="checkbox">Pet</label>
                        <label><input type="checkbox">Track</label>
                        <label><input type="checkbox">Shop</label>
                        <label><input type="checkbox">Monster</label>
                        <label><input type="checkbox">NPC</label>
                    </div>
                </div>
            </div>
            <div class="log-panel panel" style="height: 150px; margin-top: 2px;"><div class="tab-bar"><div class="tab-button active">ข้อความ</div><div class="tab-button">ทั่วไป</div><div class="tab-button">ส่วนตัว</div></div><div id="logArea" class="log-area"></div></div>
        </div>
        <div class="right-panel">
            <div class="panel" style="flex-grow:1; display: flex; flex-direction: column;">
                 <div class="tab-bar info-tabs">
                    <div class="tab-button active" onclick="showInfoTab(event, 'status')">สถานะ</div>
                    <div class="tab-button" onclick="showInfoTab(event, 'skills')">ทักษะ</div>
                    <div class="tab-button" onclick="showInfoTab(event, 'items')">ไอเทม</div>
                    <div class="tab-button" onclick="showInfoTab(event, 'party')">ปาร์ตี้</div>
                    <div class="tab-button" onclick="showInfoTab(event, 'quests')">ภารกิจ</div>
                    <div class="tab-button" onclick="showInfoTab(event, 'control')">ควบคุม</div>
                 </div>
                 <div id="tab-status" class="tab-content active"><div class="group-box"><div class="group-box-title">ข้อมูลพื้นฐาน</div>
                    <div style="display: flex; gap: 10px;">
                        <div style="width: 64px; height: 64px; border: 1px inset; background: #eee;">ภาพ</div>
                        <div>
                            <p><strong>ชื่อ:</strong> <span id="info-name">N/A</span></p>
                            <p><strong>ระดับ:</strong> <span id="info-class">N/A</span></p>
                            <p><strong>LV:</strong> <span id="info-level">0</span></p>
                        </div>
                    </div>
                    <div style="margin: 4px 0;"><label>พลังชีวิต:</label> <div class="progress-bar"><div id="hp-bar-main" class="progress-fill hp-fill"></div></div><span id="hp-text">0/0</span></div>
                    <div style="margin: 4px 0;"><label>พลังปราณ:</label> <div class="progress-bar"><div id="mp-bar-main" class="progress-fill mp-fill"></div></div><span id="mp-text">0/0</span></div>
                    <div style="margin: 4px 0;"><label>ความโกรธ:</label> <div class="progress-bar"><div id="rage-bar-main" class="progress-fill rage-fill"></div></div><span id="rage-text">0/0</span></div>
                    <div style="margin: 4px 0;"><label>ประสบการณ์:</label> <div class="progress-bar"><div id="exp-bar-main" class="progress-fill exp-fill"></div></div><span id="exp-text">0/0</span></div>
                 </div><div class="group-box"><div class="group-box-title">ค่าความสามารถ</div><div class="stat-grid"><div class="stat-item"><span>โจมตี:</span> <span id="stat-atk">0</span></div><div class="stat-item"><span>แม่นยำ:</span> <span id="stat-acc">0</span></div><div class="stat-item"><span>ป้องกัน:</span> <span id="stat-def">0</span></div><div class="stat-item"><span>หลบหลีก:</span> <span id="stat-eva">0</span></div><div class="stat-item"><span>พลังปราณ:</span> <span id="stat-chi">0</span></div><div class="stat-item"><span>โจมตีวิชา:</span> <span id="stat-skill-atk">0</span></div><div class="stat-item"><span>ป้องกันวิชา:</span> <span id="stat-skill-def">0</span></div><div class="stat-item"><span>HP:</span> <span id="stat-hp">0</span></div></div></div></div>
                 <div id="tab-skills" class="tab-content"><table class="table-list" id="skills-table"><thead><tr><th>ชื่อสกิล</th><th>ประเภท</th><th>MP</th></tr></thead><tbody></tbody></table></div>
                 <div id="tab-items" class="tab-content"><table class="table-list" id="items-table"><thead><tr><th>ชื่อไอเทม</th><th>จำนวน</th></tr></thead><tbody></tbody></table></div>
                 <div id="tab-party" class="tab-content" style="padding: 10px;">ไม่มีสมาชิกในปาร์ตี้</div>
                 <div id="tab-quests" class="tab-content" id="quests-log"><div id="quests-list"></div></div>
                 <div id="tab-control" class="tab-content">
                    <div class="group-box">
                        <div class="group-box-title">ตั้งค่าการทำงาน</div>
                        <label><input type="checkbox" id="auto-hunt-check"> เริ่มทำงานอัตโนมัติ</label><br>
                        <label><input type="checkbox" id="auto-pickup-check"> เก็บของอัตโนมัติ</label><br>
                        <label><input type="checkbox" id="auto-pot-check"> ใช้ยาอัตโนมัติ</label><br>
                        <label><input type="checkbox" id="auto-buff-check"> ใช้บัพอัตโนมัติ</label>
                    </div>
                    <div class="group-box">
                        <div class="group-box-title">ตั้งค่าการฟื้นฟู</div>
                        <div class="control-setting">
                            <label>HP ต่ำกว่า:</label>
                            <input type="number" id="hp-pot-threshold" value="60"> %
                        </div>
                        <div class="control-setting">
                            <label>MP ต่ำกว่า:</label>
                            <input type="number" id="mp-pot-threshold" value="40"> %
                        </div>
                    </div>
                     <div class="group-box">
                        <div class="group-box-title">ตั้งค่าการโจมตี</div>
                        <div class="control-setting">
                            <label for="attack-skill-select">สกิลโจมตี:</label>
                            <select id="attack-skill-select"></select>
                        </div>
                    </div>
                    <div class="group-box">
                        <div class="group-box-title">ตั้งค่าการใช้ทักษะสนับสนุน</div>
                        <div id="buff-settings-container"></div>
                    </div>
                 </div>
            </div>
             <div class="environment-panel panel" style="height: 180px; margin-top: 2px;">
                 <div class="tab-bar" id="env-tabs">
                    <div class="tab-button active" onclick="showEnvTab(event, 'monsters')">มอนสเตอร์</div>
                    <div class="tab-button" onclick="showEnvTab(event, 'npcs')">NPC</div>
                    <div class="tab-button" onclick="showEnvTab(event, 'items')">ไอเทม</div>
                    <div class="tab-button" onclick="showEnvTab(event, 'players')">ผู้เล่น</div>
                 </div>
                <div id="env-monsters" class="env-area active"><table class="table-list"><thead><tr><th>ID</th><th>ชื่อ</th><th>ระยะ</th><th>LV</th><th>สถานะ</th></tr></thead><tbody id="env-tbody-monsters"></tbody></table></div>
                <div id="env-npcs" class="env-area"><table class="table-list"><thead><tr><th>ID</th><th>ชื่อ</th><th>ตำแหน่ง</th><th>ระยะ</th></tr></thead><tbody id="env-tbody-npcs"></tbody></table></div>
                <div id="env-items" class="env-area" style="padding: 5px;">ยังไม่เปิดใช้งาน</div>
                <div id="env-players" class="env-area" style="padding: 5px;">ยังไม่เปิดใช้งาน</div>
            </div>
        </div>
    </div>
    <div class="status-bar">
        <span class="status-bar-panel">ygLight Version 3.0.5.0 Copyright ©2006 yglight All rights reserved</span>
        <span class="status-bar-panel" id="status-bar-coords">พิกัด: 0, 0</span>
        <span class="status-bar-panel">RXBuff: 0 | TX: 0 | RX: 0</span>
    </div>
</div>

<div id="dialog-overlay" class="overlay">
    <div class="dialog-window">
        <div class="dialog-title-bar" id="dialog-title"></div>
        <div class="dialog-content" id="dialog-text"></div>
        <div class="dialog-buttons" id="dialog-buttons-container"></div>
    </div>
</div>

<script>
// --- CONSTANTS ---
const SAVE_DATA_KEY = 'ygLightBotSaveData';
const MAP_WIDTH_PX = 480;
const MAP_HEIGHT_PX = 250;
const GAME_X_MIN = -3000;
const GAME_X_MAX = 3000;
const GAME_Y_MIN = -2500;
const GAME_Y_MAX = 2500;


// --- YULGANG DATABASE (BASED ON PC TH) ---
const YULGANG_DB = {
    spawnZones: {
        "1": { minX: -1800, maxX: -1400, minY: 1500, maxY: 1800 }, // Bobcat - Riverside Plains
        "2": { minX: -2200, maxX: -1800, minY: 500, maxY: 1000 },  // Wolf - Pirate Branch Area
        "3": { minX: 1500, maxX: 2000, minY: 1600, maxY: 2000 }, // Fox - Ruined Farm
        "4": { minX: -500, maxX: 500, minY: -500, maxY: 500}, // Boar - Near Lord Banes Villa
    },
    monsters: {
        "1": { name: "บ็อบแคท", level: 1, hp: 45, exp: 10, atk: 5, def: 1, drops: { 'หนังบ็อบแคท': 0.5, 'เงิน': 0.8 } },
        "2": { name: "หมาป่า", level: 3, hp: 80, exp: 15, atk: 8, def: 2, drops: { 'ยาแดง(เล็ก)': 0.3, 'เงิน': 0.9, 'เขี้ยวหมาป่า': 0.25 } },
        "3": { name: "จิ้งจอกสามหาง", level: 4, hp: 100, exp: 18, atk: 10, def: 4, drops: { 'ยาฟ้า(เล็ก)': 0.2, 'เงิน': 1.0, 'หางจิ้งจอก': 0.2 } },
        "4": { name: "หมูป่า", level: 5, hp: 120, exp: 20, atk: 12, def: 5, drops: { 'ยาแดง(เล็ก)': 0.4, 'เงิน': 1.0, 'เนื้อหมูป่า': 0.3 } },
        "5": { name: "หมาป่าดุร้าย", level: 8, hp: 180, exp: 40, atk: 20, def: 8, drops: { 'ยาแดง(กลาง)': 0.1, 'เงิน': 1.0, 'กรงเล็บหมาป่า': 0.15 } },
        "6": { name: "โจรป่า", level: 10, hp: 210, exp: 50, atk: 25, def: 10, drops: { 'ยาแดง(กลาง)': 0.2, 'เงิน': 1.0, 'ดาบฝึกหัด': 0.05 } },
    },
    npcs: {
        "1": { id: 1, name: "เฒ่ายา", title: "เจ้าของร้านยา", location: "เมืองฮอนบัล", x: 150, y: 200, isVendor: true, vendorItems: ["red_pot_s", "blue_pot_s"] },
        "2": { id: 2, name: "โล้นเหล็กไหล", title: "ช่างตีเหล็ก", location: "เมืองฮอนบัล", x: 180, y: 210, isVendor: false },
        "3": { id: 3, name: "เจ้าเมืองฮอนบัล", title: "เจ้าเมือง", location: "เมืองฮอนบัล", x: 200, y: 180, isVendor: false },
    },
    items: {
        "หนังบ็อบแคท": { name: "หนังบ็อบแคท", type: "quest" },
        "เขี้ยวหมาป่า": { name: "เขี้ยวหมาป่า", type: "quest" },
        "ยาแดง(เล็ก)": { id: "red_pot_s", name: "ยาแดง(เล็ก)", type: "potion", buyPrice: 50 },
        "ยาฟ้า(เล็ก)": { id: "blue_pot_s", name: "ยาฟ้า(เล็ก)", type: "potion", buyPrice: 80 },
    },
    quests: {
        "1": { id: 1, title: "ยาของเฒ่ายา", npcId: 1, startDialog: "โอ้ย... ปวดหลังจริงๆเลย เจ้าหนู! ข้าต้องการ 'หนังบ็อบแคท' 5 ชิ้น มาทำยาแก้ปวดหลังให้ข้าหน่อยได้หรือไม่?", completeDialog: "โอ้! ในที่สุดก็ได้มาครบเสียที ขอบใจเจ้ามาก นี่คือรางวัลของเจ้า", objectives: [{ type: "collect", itemName: "หนังบ็อบแคท", amount: 5 }], reward: { exp: 100, money: 500 }, status: "available" },
        "2": { id: 2, title: "ศาสตราวุธของช่างเหล็ก", npcId: 2, startDialog: "อาวุธดีๆ ต้องใช้ของดีๆ! ไปหา 'เขี้ยวหมาป่า' มาให้ข้า 10 ชิ้นสิ แล้วข้าจะทำของดีให้เจ้าดู", completeDialog: "เยี่ยม! เขี้ยวพวกนี้แหลมคมใช้ได้เลย เอ้านี่รางวัลของเจ้า", objectives: [{ type: "collect", itemName: "เขี้ยวหมาป่า", amount: 10 }], reward: { exp: 250, money: 1000 }, status: "available" }
    },
    skills: {
        "ninja_atk_1": { id:"ninja_atk_1", name: "ลับร่างมรณะ", type: "attack", level: 1, mp_cost: 15, damage_multiplier: 1.2 },
        "ninja_buf_1": { id: "speed_buff", name: "ทะยานผ่านร้อยลี้", type: "buff", icon: "🏃", level: 1, mp_cost: 20, duration: 180 }
    }
};

const CHARACTER_TEMPLATE = {
    name: "ศิลปินเดี่ยว07", class: "นินจา", level: 10, honor: 3456, money: 50000,
    x: -250, y: 250, // Start near Lord Banes Villa bridge (in-game coords)
    hp: 214, maxHp: 214, mp: 150, maxMp: 150, rage: 1000, maxRage: 1000, exp: 633, maxExp: 938,
    stats: { atk: 39, acc: 97, def: 18, eva: 24, chi: 25, skill_atk: 18, skill_def: 28, hp_stat: 45 },
    skills: [YULGANG_DB.skills.ninja_atk_1, YULGANG_DB.skills.ninja_buf_1], 
    inventory: [{ name: 'ยาแดง(เล็ก)', quantity: 50 }], activeQuests: [], buffs: [],
    settings: {
        autoHunt: false, autoPotion: false, autoPickup: false, autoBuff: false,
        hpPotThreshold: 60, mpPotThreshold: 40,
        attackSkill: "ninja_atk_1",
        activeBuffs: { "speed_buff": true }
    }
};

// --- APPLICATION STATE ---
let gameState = {};
let gameInterval, buffInterval;

// --- UI SELECTORS ---
const ui = {
    appScreen: document.getElementById('app-screen'), logArea: document.getElementById('logArea'),
    envTbodyMonsters: document.getElementById('env-tbody-monsters'), envTbodyNpcs: document.getElementById('env-tbody-npcs'),
    itemsTbody: document.querySelector('#items-table tbody'), skillsTbody: document.querySelector('#skills-table tbody'),
    questsList: document.getElementById('quests-list'),
    dialogOverlay: document.getElementById('dialog-overlay'), dialogTitle: document.getElementById('dialog-title'),
    dialogText: document.getElementById('dialog-text'), dialogButtons: document.getElementById('dialog-buttons-container'),
    playerDot: document.getElementById('player-dot'),
    buffBar: document.getElementById('buff-bar-main'),
    attackSkillSelect: document.getElementById('attack-skill-select'),
    buffSettingsContainer: document.getElementById('buff-settings-container'),
    statusBarCoords: document.getElementById('status-bar-coords')
};

// --- DATA MANAGEMENT ---
function loadCharacterData() {
    const savedData = localStorage.getItem(SAVE_DATA_KEY);
    if (savedData) {
        return JSON.parse(savedData);
    }
    return JSON.parse(JSON.stringify(CHARACTER_TEMPLATE)); // Return a fresh copy
}

function saveCurrentCharacterData() {
    if (!gameState.loggedIn) return;
    localStorage.setItem(SAVE_DATA_KEY, JSON.stringify(gameState.character));
    // No log message here to avoid spamming on page close
}

// --- UI LOGIC ---
function showAlertDialog(title, message, buttons) {
    ui.dialogTitle.textContent = title;
    ui.dialogText.innerHTML = message;
    ui.dialogButtons.innerHTML = '';
    buttons.forEach(btn => {
        const buttonEl = document.createElement('button');
        buttonEl.textContent = btn.text;
        buttonEl.onclick = btn.handler;
        ui.dialogButtons.appendChild(buttonEl);
    });
    ui.dialogOverlay.style.display = 'flex';
}

function closeDialog() { ui.dialogOverlay.style.display = 'none'; }

function showInfoTab(event, tabName) {
    document.querySelectorAll('.info-tabs .tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.info-tabs .tab-button').forEach(el => el.classList.remove('active'));
    document.getElementById(`tab-${tabName}`).classList.add('active');
    event.target.classList.add('active');
}

function showEnvTab(event, tabName) {
    document.querySelectorAll('#env-tabs ~ .env-area').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('#env-tabs .tab-button').forEach(el => el.classList.remove('active'));
    const tabContent = document.getElementById(`env-${tabName}`);
    if(tabContent) tabContent.classList.add('active');
    event.target.classList.add('active');
}

function addLog(message, className) {
    if (!ui.logArea) return;
    const timestamp = new Date().toLocaleTimeString('th-TH', { hour12: false });
    const logEntry = document.createElement('div');
    logEntry.className = className;
    logEntry.innerHTML = `[${timestamp}] ${message}`;
    ui.logArea.appendChild(logEntry);
    ui.logArea.scrollTop = ui.logArea.scrollHeight;
}

// --- NPC & SHOP LOGIC ---
function openNpcDialog(npcId) {
    const npc = YULGANG_DB.npcs[npcId];
    if (!npc) return;
    
    let buttons = [];
    let dialogText = "";

    const completedQuest = gameState.character.activeQuests.find(q => YULGANG_DB.quests[q.id].npcId === npc.id && YULGANG_DB.quests[q.id].status === 'completed');
    if (completedQuest) {
        dialogText = YULGANG_DB.quests[completedQuest.id].completeDialog;
        buttons.push({ text: '[ส่งเควส]', handler: () => turnInQuest(completedQuest.id) });
    } else {
        const availableQuest = Object.values(YULGANG_DB.quests).find(q => q.npcId === npc.id && q.status === 'available');
        if (availableQuest) {
            dialogText = availableQuest.startDialog;
            buttons.push({ text: '[รับเควส]', handler: () => acceptQuest(availableQuest.id) });
        } else {
            dialogText = "มีอะไรให้ข้ารับใช้หรือไม่?";
        }
    }
    
    if (npc.isVendor) { buttons.push({ text: '[ซื้อ/ขายไอเทม]', handler: () => openShopWindow(npc.id) }); }
    buttons.push({ text: '[ลาก่อน]', handler: closeDialog });
    
    showAlertDialog(npc.name, dialogText, buttons);
}

function openShopWindow(npcId) {
    const npc = YULGANG_DB.npcs[npcId];
    if (!npc || !npc.isVendor) return;
    
    const itemsHtml = npc.vendorItems.map(itemId => {
        const item = Object.values(YULGANG_DB.items).find(i => i.id === itemId);
        return item ? `<div class="shop-item"><span>${item.name}</span><span>ราคา: ${item.buyPrice} สลึง</span><button onclick="buyItem('${item.name}', ${item.buyPrice})">ซื้อ</button></div>` : '';
    }).join('');

    const shopContent = `<div style="max-height: 300px; overflow-y: auto;">${itemsHtml}</div>`;
    
    showAlertDialog(`ร้านค้าของ ${npc.name}`, shopContent, [{ text: '[ปิดร้านค้า]', handler: closeDialog }]);
}

function buyItem(itemName, price) {
    if (gameState.character.money >= price) {
        gameState.character.money -= price;
        addItemToInventory(itemName, 1);
        addLog(`ซื้อ ${itemName} 1 ชิ้น ในราคา ${price} สลึง`, 'log-item');
        updateUI();
    } else {
        closeDialog(); // Close shop window first
        setTimeout(() => showAlertDialog('ผิดพลาด', 'เงินไม่พอสำหรับซื้อ ' + itemName, [{ text: '[ตกลง]', handler: closeDialog }]), 10);
    }
}

// --- QUEST LOGIC ---
function acceptQuest(questId) {
    const quest = YULGANG_DB.quests[questId];
    if (!quest || quest.status !== 'available') return;
    quest.status = 'active';
    const questData = { id: quest.id, title: quest.title, objectives: JSON.parse(JSON.stringify(quest.objectives)), progress: {} };
    questData.objectives.forEach(obj => { if (obj.type === 'collect') { questData.progress[obj.itemName] = 0; } });
    gameState.character.activeQuests.push(questData);
    addLog(`รับภารกิจใหม่: ${quest.title}`, 'log-quest');
    closeDialog(); updateUI();
}

function turnInQuest(questId) {
    const questIndex = gameState.character.activeQuests.findIndex(q => q.id === questId);
    if (questIndex === -1) return;
    const questData = gameState.character.activeQuests[questIndex];
    const dbQuest = YULGANG_DB.quests[questId];
    questData.objectives.forEach(obj => { if (obj.type === 'collect') { removeItemFromInventory(obj.itemName, obj.amount); } });
    const reward = dbQuest.reward;
    gameState.character.exp += reward.exp;
    gameState.character.money += reward.money;
    addLog(`สำเร็จภารกิจ: ${dbQuest.title}! ได้รับ EXP +${reward.exp}, เงิน +${reward.money}`, 'log-exp');
    gameState.character.activeQuests.splice(questIndex, 1);
    dbQuest.status = 'done';
    checkLevelUp(); closeDialog(); updateUI();
}

function updateQuestProgress(itemName) {
    gameState.character.activeQuests.forEach(quest => {
        const dbQuest = YULGANG_DB.quests[quest.id];
        if (dbQuest.status !== 'active') return;
        quest.objectives.forEach(obj => {
            if (obj.type === 'collect' && obj.itemName === itemName) {
                if (quest.progress[obj.itemName] < obj.amount) {
                    quest.progress[obj.itemName]++;
                    addLog(`[ภารกิจ] เก็บ ${itemName} (${quest.progress[obj.itemName]}/${obj.amount})`, 'log-quest');
                    checkQuestCompletion(quest);
                }
            }
        });
    });
}

function checkQuestCompletion(quest) {
    const isCompleted = quest.objectives.every(obj => (obj.type === 'collect') ? quest.progress[obj.itemName] >= obj.amount : true);
    if (isCompleted) {
        const dbQuest = YULGANG_DB.quests[quest.id];
        if(dbQuest.status === 'active') {
            dbQuest.status = 'completed';
            addLog(`[ภารกิจ] ${quest.title} สำเร็จแล้ว! กลับไปคุยกับ ${YULGANG_DB.npcs[dbQuest.npcId].name}`, 'log-quest');
        }
    }
}

// --- GAME LOGIC ---
function initializeGame() {
    gameState = {
        loggedIn: true, 
        targetId: null, isMoving: false,
        character: loadCharacterData(),
        environment: { monsters: [], npcs: [] }
    };
    let monsterIdCounter = 1;
    
    for(let i=0; i<10; i++) {
        const monsterDbId = Object.keys(YULGANG_DB.monsters)[i % Object.keys(YULGANG_DB.monsters).length];
        const zone = YULGANG_DB.spawnZones[monsterDbId] || YULGANG_DB.spawnZones["1"];
        const spawnPos = getRandomCoordsInZone(zone);
        gameState.environment.monsters.push({
            id: monsterIdCounter++, dbId: monsterDbId, currentHp: YULGANG_DB.monsters[monsterDbId].hp,
            x: spawnPos.x, y: spawnPos.y
        });
    }
    gameState.environment.npcs = Object.values(YULGANG_DB.npcs);
    Object.values(YULGANG_DB.quests).forEach(q => q.status = 'available');
    
    gameState.character.activeQuests.forEach(activeQuest => {
        if (YULGANG_DB.quests[activeQuest.id]) {
            YULGANG_DB.quests[activeQuest.id].status = 'active';
            checkQuestCompletion(activeQuest);
        }
    });

    addLog(`ยินดีต้อนรับ, ${gameState.character.name}!`, 'log-exp');
    document.getElementById('char-name').value = gameState.character.name;
    
    setupControlPanel();

    gameInterval = setInterval(gameLoop, 2000);
    buffInterval = setInterval(() => { if(gameState.loggedIn) handleBuffs() }, 1000);
    updateUI();
}

function gameLoop() {
    if (!gameState.loggedIn) return;
    
    handleAutoPotions();

    if (!gameState.character.settings.autoHunt || gameState.isMoving) return;
    if (gameState.targetId === null) { findNewTarget(); }
    const target = gameState.environment.monsters.find(m => m.id === gameState.targetId);
    if (!target || target.currentHp <= 0) { gameState.targetId = null; return; }
    const dist = Math.hypot(target.x - gameState.character.x, target.y - gameState.character.y);
    if (dist > 150) { // Attack range in game units
        moveTo(target.x, target.y);
    } 
    else { attackTarget(target); }
}

function handleBuffs() {
    if(gameState.character.settings.autoBuff) {
        const buffSkills = gameState.character.skills.filter(s => s.type === 'buff');
        buffSkills.forEach(buffSkill => {
            if (gameState.character.settings.activeBuffs[buffSkill.id] && !gameState.character.buffs.some(b => b.id === buffSkill.id)) {
                if (gameState.character.mp >= buffSkill.mp_cost) {
                    gameState.character.mp -= buffSkill.mp_cost;
                    gameState.character.buffs.push({ id: buffSkill.id, name: buffSkill.name, icon: buffSkill.icon, timeLeft: buffSkill.duration });
                    addLog(`ใช้สกิลบัฟ [${buffSkill.name}]`, 'log-skill');
                }
            }
        });
    }
    gameState.character.buffs.forEach((buff, index) => {
        buff.timeLeft--;
        if (buff.timeLeft <= 0) {
            gameState.character.buffs.splice(index, 1);
            addLog(`บัฟ [${buff.name}] หมดเวลา`, 'log-info');
        }
    });
    updateUI();
}

function handleAutoPotions() {
    const char = gameState.character;
    const settings = char.settings;
    if (!settings.autoPotion) return;

    if ((char.hp / char.maxHp) * 100 < settings.hpPotThreshold) {
        const redPot = char.inventory.find(i => i.name.includes("ยาแดง"));
        if (redPot) {
            char.hp = Math.min(char.maxHp, char.hp + 50);
            removeItemFromInventory(redPot.name, 1);
            addLog(`HP < ${settings.hpPotThreshold}%, ใช้ ${redPot.name}`, 'log-system');
        }
    }
    if ((char.mp / char.maxMp) * 100 < settings.mpPotThreshold) {
        const bluePot = char.inventory.find(i => i.name.includes("ยาฟ้า"));
        if(bluePot) {
            char.mp = Math.min(char.maxMp, char.mp + 50);
            removeItemFromInventory(bluePot.name, 1);
            addLog(`MP < ${settings.mpPotThreshold}%, ใช้ ${bluePot.name}`, 'log-system');
        }
    }
}

function findNewTarget() {
    const availableTargets = gameState.environment.monsters.filter(m => m.currentHp > 0);
    if (availableTargets.length > 0) {
        availableTargets.sort((a,b) => Math.hypot(a.x - gameState.character.x, a.y - gameState.character.y) - Math.hypot(b.x - gameState.character.x, b.y - gameState.character.y));
        gameState.targetId = availableTargets[0].id;
        const targetInfo = YULGANG_DB.monsters[availableTargets[0].dbId];
        addLog(`ค้นพบเป้าหมาย: ${targetInfo.name} ที่พิกัด [${availableTargets[0].x}, ${availableTargets[0].y}]`, 'log-info');
    }
}

function clamp(value, min, max) {
    return Math.max(min, Math.min(max, value));
}

function moveTo(x, y) {
    gameState.isMoving = true;
    addLog(`กำลังเคลื่อนที่ไปยัง [${x}, ${y}]...`, 'log-info');
    setTimeout(() => {
        if (!gameState.loggedIn) return;
        gameState.character.x = clamp(x + (Math.random() * 40 - 20), GAME_X_MIN, GAME_X_MAX);
        gameState.character.y = clamp(y + (Math.random() * 40 - 20), GAME_Y_MIN, GAME_Y_MAX);
        gameState.isMoving = false;
        addLog(`ถึงที่หมายแล้ว ตำแหน่งปัจจุบัน [${Math.floor(gameState.character.x)}, ${Math.floor(gameState.character.y)}]`, 'log-info');
        updateUI();
    }, 1500);
}

function returnToTown() {
    if (!gameState.loggedIn) return;
    addLog(`ใช้ยันต์กลับเมือง...`, 'log-system');
    moveTo(-250, 250);
    gameState.character.hp = gameState.character.maxHp;
    gameState.character.mp = gameState.character.maxMp;
    addLog(`ฟื้นฟูพลังชีวิตและพลังปราณเต็ม`, 'log-system');
    updateUI();
}

function attackTarget(target) {
    const targetInfo = YULGANG_DB.monsters[target.dbId];
    const attackSkillId = gameState.character.settings.attackSkill;
    const skill = Object.values(YULGANG_DB.skills).find(s => s.id === attackSkillId);
    let damage = 0;

    if (skill && skill.type === 'attack' && gameState.character.mp >= skill.mp_cost) {
        gameState.character.mp -= skill.mp_cost;
        damage = Math.max(1, Math.floor((gameState.character.stats.atk * skill.damage_multiplier) - targetInfo.def));
        addLog(`ใช้สกิล [${skill.name}] โจมตี ${targetInfo.name}`, 'log-skill');
    } else {
        damage = Math.max(1, Math.floor(gameState.character.stats.atk + (Math.random() * 5) - targetInfo.def));
        addLog(`โจมตี ${targetInfo.name}`, 'log-attack');
    }
    
    target.currentHp = Math.max(0, target.currentHp - damage);
    addLog(`สร้างความเสียหาย ${damage} หน่วย (HP: ${target.currentHp}/${targetInfo.hp})`, 'log-attack');
    
    if (target.currentHp <= 0) { handleMonsterDefeat(target); } 
    else {
        setTimeout(() => {
             if(target.currentHp <= 0) return;
             const monsterDamage = Math.max(1, Math.floor(targetInfo.atk - (gameState.character.stats.def/2)));
             gameState.character.hp = Math.max(0, gameState.character.hp - monsterDamage);
             addLog(`${targetInfo.name} โจมตีกลับ, ได้รับความเสียหาย ${monsterDamage} หน่วย`, 'log-error');
        }, 500);
    }
    updateUI();
}

function getRandomCoordsInZone(zone) {
    const x = zone.minX + Math.random() * (zone.maxX - zone.minX);
    const y = zone.minY + Math.random() * (zone.maxY - zone.minY);
    return { x: Math.floor(x), y: Math.floor(y) };
}

function handleMonsterDefeat(target) {
    const targetInfo = YULGANG_DB.monsters[target.dbId];
    addLog(`กำจัด ${targetInfo.name} สำเร็จ!`, 'log-exp');
    gameState.character.exp += targetInfo.exp;
    addLog(`ได้รับค่าประสบการณ์ ${targetInfo.exp} หน่วย`, 'log-exp');
    
    if (gameState.character.settings.autoPickup && targetInfo.drops) {
        for (const itemName in targetInfo.drops) {
            if (Math.random() < targetInfo.drops[itemName]) {
                if (itemName === 'เงิน') {
                    const amount = 10 + Math.floor(Math.random() * targetInfo.level * 10);
                    gameState.character.money += amount;
                    addLog(`ได้รับ ${amount.toLocaleString()} สลึง`, 'log-item');
                } else {
                    addItemToInventory(itemName, 1);
                    addLog(`ได้รับไอเทม: ${itemName}`, 'log-item');
                    updateQuestProgress(itemName);
                }
            }
        }
    }
    
    checkLevelUp();
    gameState.targetId = null;

    setTimeout(() => {
         if (!gameState.loggedIn) return;
         const monsterIndex = gameState.environment.monsters.findIndex(m => m.id === target.id);
         if(monsterIndex !== -1){
             const zone = YULGANG_DB.spawnZones[target.dbId] || YULGANG_DB.spawnZones["1"];
             const spawnPos = getRandomCoordsInZone(zone);
             gameState.environment.monsters[monsterIndex].currentHp = targetInfo.hp;
             gameState.environment.monsters[monsterIndex].x = spawnPos.x;
             gameState.environment.monsters[monsterIndex].y = spawnPos.y;
             addLog(`${targetInfo.name} เกิดใหม่แล้วที่ [${spawnPos.x}, ${spawnPos.y}]`, 'log-system');
             updateUI();
         }
    }, 5000);
}

function addItemToInventory(name, quantity) {
    const existingItem = gameState.character.inventory.find(item => item.name === name);
    if (existingItem) { existingItem.quantity += quantity; } else { gameState.character.inventory.push({ name, quantity }); }
}

function removeItemFromInventory(name, quantity) {
    const itemIndex = gameState.character.inventory.findIndex(item => item.name === name);
    if (itemIndex > -1) {
        gameState.character.inventory[itemIndex].quantity -= quantity;
        if (gameState.character.inventory[itemIndex].quantity <= 0) {
            gameState.character.inventory.splice(itemIndex, 1);
        }
    }
}

function checkLevelUp() {
    if (gameState.character.exp >= gameState.character.maxExp) {
        gameState.character.level++;
        gameState.character.exp -= gameState.character.maxExp;
        gameState.character.maxExp = Math.floor(gameState.character.maxExp * 1.5);
        gameState.character.maxHp += 20;
        gameState.character.maxMp += 10;
        gameState.character.hp = gameState.character.maxHp;
        gameState.character.mp = gameState.character.maxMp;
        addLog(`เลเวลอัพ! คุณไปถึงเลเวล ${gameState.character.level} แล้ว!`, 'log-exp');
    }
}

// --- UI UPDATE FUNCTION ---
function updateUI() {
    if (!gameState.loggedIn) { return; };
    const char = gameState.character;
    const fields = {
        'info-name': char.name, 'info-class': char.class, 'info-level': char.level,
        'hp-text': `${char.hp}/${char.maxHp}`, 'mp-text': `${char.mp}/${char.maxMp}`, 'rage-text': `${char.rage}/${char.maxRage}`, 'exp-text': `${char.exp}/${char.maxExp}`,
        'stat-atk': char.stats.atk, 'stat-acc': char.stats.acc, 'stat-def': char.stats.def, 'stat-eva': char.stats.eva, 'stat-chi': char.stats.chi, 'stat-skill-atk': char.stats.skill_atk, 'stat-skill-def': char.stats.skill_def, 'stat-hp': char.stats.hp_stat
    };
    for(const id in fields) { if(document.getElementById(id)) document.getElementById(id).textContent = fields[id]; }

    const bars = { 'hp-bar-top': (char.hp / char.maxHp), 'mp-bar-top': (char.mp / char.maxMp), 'exp-bar-top': (char.exp / char.maxExp), 'hp-bar-main': (char.hp / char.maxHp), 'mp-bar-main': (char.mp / char.maxMp), 'exp-bar-main': (char.exp / char.maxExp), 'rage-bar-main': (char.rage / char.maxRage) };
    for(const id in bars) { document.getElementById(id).style.width = `${bars[id] * 100}%`; }
    document.getElementById('hp-percent-top').textContent = `${Math.floor(bars['hp-bar-top']*100)}%`;
    document.getElementById('mp-percent-top').textContent = `${Math.floor(bars['mp-bar-top']*100)}%`;
    document.getElementById('exp-percent-top').textContent = `${Math.floor(bars['exp-bar-top']*100)}%`;
    document.getElementById('stat-lv-top').textContent = char.level;
    ui.statusBarCoords.textContent = `พิกัด: ${Math.floor(char.x)}, ${Math.floor(char.y)}`;

    ui.envTbodyMonsters.innerHTML = gameState.environment.monsters.map(mob => { const info = YULGANG_DB.monsters[mob.dbId]; const status = mob.currentHp > 0 ? `${mob.currentHp}/${info.hp}` : 'ตาย'; const dist = Math.floor(Math.hypot(mob.x - char.x, mob.y - char.y)); return `<tr class="${mob.id === gameState.targetId ? 'targeted' : ''}"><td>${mob.id}</td><td>${info.name}</td><td>${dist}</td><td>${info.level}</td><td>${status}</td></tr>`; }).join('');
    ui.envTbodyNpcs.innerHTML = gameState.environment.npcs.map(npc => { const dist = Math.floor(Math.hypot(npc.x - char.x, npc.y - char.y)); return `<tr class="clickable" onclick="openNpcDialog(${npc.id})"><td>${npc.id}</td><td>${npc.name}</td><td>${npc.location}</td><td>${dist}</td></tr>` }).join('');
    ui.itemsTbody.innerHTML = char.inventory.map(item => `<tr><td>${item.name}</td><td>${item.quantity.toLocaleString()}</td></tr>`).join('');
    ui.skillsTbody.innerHTML = char.skills.map(skill => `<tr><td>${skill.name}</td><td>${skill.type}</td><td>${skill.mp_cost}</td></tr>`).join('');
    ui.questsList.innerHTML = char.activeQuests.map(q => { let p = q.objectives.map(obj => (obj.type === 'collect') ? `<li>${obj.itemName}: ${q.progress[obj.itemName]} / ${obj.amount}</li>` : '').join(''); return `<div class="group-box" style="font-size:10px;"><div class="group-box-title">${q.title}</div><ul>${p}</ul></div>`; }).join('');
    
    const mapCoords = gameToMapCoords(char.x, char.y);
    ui.playerDot.style.left = `${mapCoords.x}px`;
    ui.playerDot.style.top = `${mapCoords.y}px`;
    ui.buffBar.innerHTML = char.buffs.map(b => `<div class="buff-icon">${b.icon}<span class="tooltip">${b.name} (${b.timeLeft}s)</span></div>`).join('');
}

function setupControlPanel() {
    const settings = gameState.character.settings;
    
    document.getElementById('auto-hunt-check').checked = settings.autoHunt;
    document.getElementById('auto-pickup-check').checked = settings.autoPickup;
    document.getElementById('auto-buff-check').checked = settings.autoBuff;
    document.getElementById('auto-pot-check').checked = settings.autoPotion;
    
    document.getElementById('hp-pot-threshold').value = settings.hpPotThreshold;
    document.getElementById('mp-pot-threshold').value = settings.mpPotThreshold;

    const attackSkills = gameState.character.skills.filter(s => s.type === 'attack');
    ui.attackSkillSelect.innerHTML = attackSkills.map(s => `<option value="${s.id}" ${s.id === settings.attackSkill ? 'selected' : ''}>${s.name}</option>`).join('');

    const buffSkills = gameState.character.skills.filter(s => s.type === 'buff');
    ui.buffSettingsContainer.innerHTML = buffSkills.map(s => `
        <label>
            <input type="checkbox" data-buff-id="${s.id}" ${settings.activeBuffs[s.id] ? 'checked' : ''}> ${s.name}
        </label>
    `).join('');
}

// --- INITIALIZATION ---
window.onload = () => {
    initializeGame();

    // Event listeners for control panel
    document.getElementById('auto-hunt-check').addEventListener('change', (e) => { if(gameState.loggedIn) gameState.character.settings.autoHunt = e.target.checked; addLog(`ระบบล่าอัตโนมัติ ${e.target.checked ? 'เปิด' : 'ปิด'}`, 'log-system'); });
    document.getElementById('auto-pickup-check').addEventListener('change', (e) => { if(gameState.loggedIn) gameState.character.settings.autoPickup = e.target.checked; addLog(`ระบบเก็บของอัตโนมัติ ${e.target.checked ? 'เปิด' : 'ปิด'}`, 'log-system'); });
    document.getElementById('auto-buff-check').addEventListener('change', (e) => { if(gameState.loggedIn) gameState.character.settings.autoBuff = e.target.checked; addLog(`ระบบบัพอัตโนมัติ ${e.target.checked ? 'เปิด' : 'ปิด'}`, 'log-system'); });
    document.getElementById('auto-pot-check').addEventListener('change', (e) => { if(gameState.loggedIn) gameState.character.settings.autoPotion = e.target.checked; addLog(`ระบบยาอัตโนมัติ ${e.target.checked ? 'เปิด' : 'ปิด'}`, 'log-system'); });
    
    document.getElementById('hp-pot-threshold').addEventListener('change', (e) => { if(gameState.loggedIn) gameState.character.settings.hpPotThreshold = parseInt(e.target.value); });
    document.getElementById('mp-pot-threshold').addEventListener('change', (e) => { if(gameState.loggedIn) gameState.character.settings.mpPotThreshold = parseInt(e.target.value); });
    document.getElementById('attack-skill-select').addEventListener('change', (e) => { if(gameState.loggedIn) gameState.character.settings.attackSkill = e.target.value; });

    ui.buffSettingsContainer.addEventListener('change', (e) => {
        if (e.target.type === 'checkbox' && gameState.loggedIn) {
            const buffId = e.target.dataset.buffId;
            gameState.character.settings.activeBuffs[buffId] = e.target.checked;
        }
    });

    // Save data before closing the window/tab
    window.addEventListener('beforeunload', saveCurrentCharacterData);
};
</script>
</body>
</html>
