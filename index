<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ygLight Bot - Yulgang Simulation v6</title>
    <style>
        /* --- Core Styles & Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Tahoma:wght@400;700&display=swap');
        :root { --main-bg: #f0f0f0; --border-out-top-left: #fff; --border-out-bottom-right: #808080; --border-in-top-left: #808080; --border-in-bottom-right: #fff; --inactive-tab-bg: #d4d0c8; }
        * { box-sizing: border-box; user-select: none; }
        body { font-family: 'Tahoma', sans-serif; font-size: 11px; background: #3a6ea5; margin: 0; padding: 2px; color: #000; overflow: hidden; }

        /* --- Window Styles --- */
        .main-window { width: 800px; height: 600px; background: var(--main-bg); border: 1px solid #0831d9; box-shadow: 1px 1px 5px rgba(0,0,0,0.5); display: flex; flex-direction: column; margin: 20px auto; }
        .title-bar { background: linear-gradient(to bottom, #005cda, #004ba9); color: white; padding: 3px 5px; font-weight: bold; display: flex; align-items: center; height: 22px; cursor: default; }
        .title-bar-text { flex-grow: 1; }
        .title-bar-icon { width: 16px; height: 16px; margin-right: 4px; background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAACLSURBVDhPY/j///9/AymASYQBAAEYQJsu7ueK8T8i40A0A0j2XwYxBiAhAGsgIgYYA1KBgAAGGgC18P+TqVj/M3My/2dkZPzPyMr4n5GR8T8jK+N/RlbG/4ysjP8ZWRn/M7IyfmdkZfxPyMr4/w9A7X//MzIy/mdkZfyf0ZUBKkCqfQAAAHSkAYYZbftAAAAAAElFTkSuQmCC') no-repeat center center; }
        .window-controls button { width: 18px; height: 16px; border: 1px outset var(--border-out-top-left); background: var(--inactive-tab-bg); font-family: 'Marlett', 'Webdings'; font-size: 10px; margin-left: 2px; line-height: 12px; text-align: center; }
        
        /* --- Panel & Layout Styles --- */
        .content-area { display: flex; flex-grow: 1; padding: 2px; overflow: hidden; }
        .panel { border: 1px solid; border-color: var(--border-in-top-left) var(--border-out-top-left) var(--border-out-top-left) var(--border-in-top-left); background: var(--main-bg); padding: 1px; }
        .panel-inset { border: 1px solid; border-color: var(--border-in-top-left) var(--border-out-top-left) var(--border-out-top-left) var(--border-in-top-left); box-shadow: inset 1px 1px 0 #c0c0c0; }
        .group-box { border: 1px solid var(--border-in-top-left); padding: 10px 5px 5px 5px; margin: 5px; position: relative; }
        .group-box-title { position: absolute; top: -7px; left: 8px; background: var(--main-bg); padding: 0 4px; }
        .left-panel { width: 480px; display: flex; flex-direction: column; padding-right: 2px; }
        .right-panel { width: 320px; display: flex; flex-direction: column; }

        /* --- Tab Control Styles --- */
        .tab-bar { display: flex; border-bottom: 1px solid var(--border-in-top-left); padding-left: 3px; height: 21px; }
        .tab-button { padding: 3px 8px; border: 1px solid; border-color: var(--border-out-top-left) var(--border-in-top-left) var(--border-in-top-left) var(--border-out-top-left); border-bottom: none; background: var(--inactive-tab-bg); position: relative; top: 1px; margin-right: 1px; cursor: pointer; }
        .tab-button.active { background: var(--main-bg); border-bottom: 1px solid var(--main-bg); font-weight: bold; }
        .tab-content { display: none; height: 100%; overflow-y: auto; }
        .tab-content.active { display: block; }

        /* --- Login Screen --- */
        #login-screen { width: 100%; height: 100%; display: flex; }
        .login-box { margin: 50px auto; width: 280px; padding: 20px; }
        .login-box img { display: block; margin: 10px auto; }
        .login-box .form-row { display: flex; align-items: center; margin-bottom: 8px; }
        .login-box label { width: 80px; }
        .login-box input, .login-box select { flex-grow: 1; }
        .login-box .button-group { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        
        /* --- Main App UI Elements --- */
        .top-bar { padding: 3px; display: grid; grid-template-columns: 1fr 1fr; grid-gap: 5px; border-bottom: 1px solid #c0c0c0; }
        .top-bar-section { display: flex; align-items: center; }
        .top-bar-section label { white-space: nowrap; margin-right: 4px; }
        .top-bar-section select, .top-bar-section input { flex-grow: 1; width: 100px; }
        .top-bar-stats { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
        .map-view { height: 250px; background: url(https://static.wikia.nocookie.net/sof/images/0/0b/Central_Valley.png) center/contain no-repeat; position: relative; background-color: #1a2d1a; }
        #player-dot { width: 10px; height: 10px; background-color: #0078d4; border: 2px solid white; border-radius: 50%; position: absolute; transform: translate(-50%, -50%); transition: all 0.5s linear; }
        .map-controls { padding: 4px; display: flex; justify-content: center; gap: 4px; background: var(--inactive-tab-bg); }
        .log-panel, .environment-panel { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .log-area, .env-area { flex-grow: 1; background: white; border: 1px inset var(--border-in-top-left); padding: 3px; font-family: 'Courier New', monospace; font-size: 10px; overflow-y: scroll; }
        #logArea { background-color: black; color: white; }
        .log-system { color: #00FF00; } .log-exp { color: #FFFF00; } .log-attack { color: #FF4757; } .log-item { color: #26DE81; } .log-error { color: #FF0000; } .log-info { color: #87CEEB; } .log-skill { color: #f088f8; } .log-quest { color: #99ff99; }
        .info-tabs .tab-content { padding: 5px; }
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
        .stat-item label { width: 45px; }
        .stat-item span { font-weight: bold; }
        .progress-bar { height: 12px; background: #c0c0c0; border: 1px inset var(--border-in-top-left); position: relative; flex-grow: 1; }
        .progress-fill { height: 100%; position: absolute; left:0; top:0; }
        .hp-fill { background: #FF0000; } .mp-fill { background: #0000FF; } .exp-fill { background: #ffa500; } .rage-fill { background: #8b0000; }
        .buff-bar { display: flex; gap: 4px; margin-top: 5px; padding: 2px 5px; min-height: 26px;}
        .buff-icon { width: 20px; height: 20px; background-color: #ccc; border: 1px solid #888; font-size: 14px; text-align: center; line-height: 18px; position: relative; }
        .buff-icon .tooltip { visibility: hidden; width: 120px; background-color: black; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -60px; opacity: 0; transition: opacity 0.3s; }
        .buff-icon:hover .tooltip { visibility: visible; opacity: 1; }
        
        /* --- General Controls --- */
        input, select, button { font-family: 'Tahoma', sans-serif; font-size: 11px; border: 1px solid; border-color: var(--border-in-top-left) var(--border-out-top-left) var(--border-out-top-left) var(--border-in-top-left); padding: 2px 4px; }
        button { background: var(--inactive-tab-bg); border-color: var(--border-out-top-left) var(--border-in-top-left) var(--border-in-top-left) var(--border-out-top-left); min-width: 70px; cursor: pointer; }
        button:active { border-color: var(--border-in-top-left) var(--border-out-top-left) var(--border-out-top-left) var(--border-in-top-left); }
        #app-screen { display: none; }
        .table-list { width: 100%; border-collapse: collapse; }
        .table-list th, .table-list td { border: 1px solid #c0c0c0; padding: 2px 4px; text-align: left; }
        .table-list th { background: var(--inactive-tab-bg); }
        .env-area .targeted { background-color: #ffecb3; }
        .env-area .clickable:hover { background-color: #e3f2fd; cursor: pointer; }

        /* --- Dialog & Shop Windows --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .dialog-window { width: 350px; background: var(--main-bg); border: 1px solid #0831d9; box-shadow: 2px 2px 8px rgba(0,0,0,0.6); display: flex; flex-direction: column; }
        .dialog-title-bar { background: linear-gradient(to bottom, #005cda, #004ba9); color: white; padding: 3px 5px; font-weight: bold; }
        .dialog-content { padding: 15px; font-size: 12px; line-height: 1.5; }
        .dialog-buttons { padding: 8px; text-align: right; background: var(--inactive-tab-bg); border-top: 1px solid var(--border-in-top-left); }
        .dialog-buttons button { margin-left: 5px; }
        #shop-window .dialog-content { padding: 5px; max-height: 300px; overflow-y: auto;}
        #shop-window .shop-item { display: flex; justify-content: space-between; align-items: center; padding: 4px; border-bottom: 1px solid #ccc; }

    </style>
</head>
<body>

<div class="main-window">
    <div class="title-bar"><div class="title-bar-icon"></div><span class="title-bar-text">ygLight Bot</span><div class="window-controls"><button>0</button><button>1</button><button>r</button></div></div>
    
    <div id="login-screen" class="content-area">
        <div class="login-left"><div class="group-box login-box"><div class="group-box-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
            <div class="form-row"><label for="account-select">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</label><select id="account-select"></select></div>
            <div class="form-row"><label for="login-username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</label><input type="text" id="login-username"></div>
            <div class="form-row"><label for="login-password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</label><input type="password" id="login-password"></div>
            <img src="https://i.imgur.com/G5T51Ep.png" alt="login avatar">
            <div class="button-group">
                <button onclick="handleLogin()">Login</button>
                <button onclick="showRegisterDialog()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div></div>
        <div class="login-right panel"><div class="tab-bar"><div class="tab-button active">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div></div><div id="login-status" class="tab-content active" style="padding: 10px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...</div></div>
    </div>

    <div id="app-screen" class="content-area">
        <div class="left-panel">
            <div class="panel">
                <div class="top-bar">
                    <div><div class="top-bar-section"><label for="server">‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå:</label><select id="server"><option>‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏±‡∏ô</option></select></div><div class="top-bar-section"><label for="char-name">‡∏ä‡∏∑‡πà‡∏≠:</label><input type="text" id="char-name" value="‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏´‡∏±‡∏î‡∏ö‡∏≠‡∏ó" readonly></div></div>
                    <div><div class="top-bar-section"><label for="char-select">‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£:</label><select id="char-select"><option>1</option></select><label for="pass">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</label><input type="password" id="pass" value="********" readonly></div><div class="top-bar-section"><button id="logoutBtn" onclick="handleLogout()">Logout</button></div></div>
                </div>
                <div class="top-bar-stats panel-inset">LV: <span id="stat-lv-top" style="margin-right:10px;">0</span> ‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï: <div class="progress-bar" style="width: 80px;"><div id="hp-bar-top" class="progress-fill hp-fill"></div></div><span id="hp-percent-top">0%</span> ‡∏û‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏≤‡∏ì: <div class="progress-bar" style="width: 80px;"><div id="mp-bar-top" class="progress-fill mp-fill"></div></div><span id="mp-percent-top">0%</span> ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå: <div class="progress-bar" style="width: 80px;"><div id="exp-bar-top" class="progress-fill exp-fill"></div></div><span id="exp-percent-top">0%</span></div>
                <div class="buff-bar panel-inset" id="buff-bar-main"></div>
            </div>
            <div class="panel" style="flex-grow: 1; margin-top: 2px; display: flex; flex-direction: column;">
                <div class="tab-bar"><div class="tab-button active">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div></div>
                <div class="tab-content active" style="flex-grow: 1; display:flex; flex-direction:column;">
                    <div class="map-view"><div id="player-dot"></div></div>
                    <div class="map-controls"><button onclick="returnToTown()">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡∏≠‡∏á</button><button>Track</button><button>Shop</button><button>Monster</button><button>NPC</button><button>Path</button></div>
                </div>
            </div>
            <div class="log-panel panel" style="height: 150px; margin-top: 2px;"><div class="tab-bar"><div class="tab-button active">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div></div><div id="logArea" class="log-area"></div></div>
        </div>
        <div class="right-panel">
            <div class="panel" style="flex-grow:1; display: flex; flex-direction: column;">
                 <div class="tab-bar info-tabs">
                    <div class="tab-button active" onclick="showInfoTab(event, 'status')">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
                    <div class="tab-button" onclick="showInfoTab(event, 'skills')">‡∏ó‡∏±‡∏Å‡∏©‡∏∞</div>
                    <div class="tab-button" onclick="showInfoTab(event, 'items')">‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</div>
                    <div class="tab-button" onclick="showInfoTab(event, 'quests')">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</div>
                    <div class="tab-button" onclick="showInfoTab(event, 'control')">‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</div>
                 </div>
                 <div id="tab-status" class="tab-content active"><div class="group-box"><div class="group-box-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</div><p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> <span id="info-name">N/A</span> <strong>‡∏≠‡∏≤‡∏ä‡∏µ‡∏û:</strong> <span id="info-class">N/A</span></p><p><strong>LV:</strong> <span id="info-level">0</span> <strong>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</strong> <span id="info-coords">0, 0</span></p><p><strong>‡πÄ‡∏á‡∏¥‡∏ô:</strong> <span id="info-money">0</span> ‡∏™‡∏•‡∏∂‡∏á</p><div style="margin: 4px 0;"><label>‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï:</label> <div class="progress-bar"><div id="hp-bar-main" class="progress-fill hp-fill"></div></div><span id="hp-text">0/0</span></div><div style="margin: 4px 0;"><label>‡∏û‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏≤‡∏ì:</label> <div class="progress-bar"><div id="mp-bar-main" class="progress-fill mp-fill"></div></div><span id="mp-text">0/0</span></div><div style="margin: 4px 0;"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Å‡∏£‡∏ò:</label> <div class="progress-bar"><div id="rage-bar-main" class="progress-fill rage-fill"></div></div><span id="rage-text">0/0</span></div><div style="margin: 4px 0;"><label>‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå:</label> <div class="progress-bar"><div id="exp-bar-main" class="progress-fill exp-fill"></div></div><span id="exp-text">0/0</span></div></div><div class="group-box"><div class="group-box-title">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ</div><div class="stat-grid"><div class="stat-item"><label>‡πÇ‡∏à‡∏°‡∏ï‡∏µ:</label> <span id="stat-atk">0</span></div><div class="stat-item"><label>‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥:</label> <span id="stat-acc">0</span></div><div class="stat-item"><label>‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô:</label> <span id="stat-def">0</span></div><div class="stat-item"><label>‡∏´‡∏•‡∏ö‡∏´‡∏•‡∏µ‡∏Å:</label> <span id="stat-eva">0</span></div><div class="stat-item"><label>‡∏û‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏≤‡∏ì:</label> <span id="stat-chi">0</span></div><div class="stat-item"><label>‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤:</label> <span id="stat-skill-atk">0</span></div><div class="stat-item"><label>‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤:</label> <span id="stat-skill-def">0</span></div><div class="stat-item"><label>HP:</label> <span id="stat-hp">0</span></div></div></div></div>
                 <div id="tab-skills" class="tab-content"><table class="table-list" id="skills-table"><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏Å‡∏¥‡∏•</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>MP</th></tr></thead><tbody></tbody></table></div>
                 <div id="tab-items" class="tab-content"><table class="table-list" id="items-table"><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th></tr></thead><tbody></tbody></table></div>
                 <div id="tab-quests" class="tab-content" id="quests-log"><div id="quests-list"></div></div>
                 <div id="tab-control" class="tab-content"><div class="group-box"><div class="group-box-title">‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div><label><input type="checkbox" id="auto-hunt-check"> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</label><br><label><input type="checkbox" id="auto-pot-check"> ‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</label><br><label><input type="checkbox" id="auto-pickup-check"> ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</label><br><label><input type="checkbox" id="auto-buff-check"> ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏û‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</label><br></div></div>
            </div>
             <div class="environment-panel panel" style="height: 180px; margin-top: 2px;">
                 <div class="tab-bar" id="env-tabs">
                    <div class="tab-button active" onclick="showEnvTab(event, 'monsters')">Environment</div>
                    <div class="tab-button" onclick="showEnvTab(event, 'npcs')">NPC</div>
                 </div>
                <div id="env-monsters" class="env-area active"><table class="table-list"><thead><tr><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏û‡∏¥‡∏Å‡∏±‡∏î</th><th>LV</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody id="env-tbody-monsters"></tbody></table></div>
                <div id="env-npcs" class="env-area"><table class="table-list"><thead><tr><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th><th>‡∏û‡∏¥‡∏Å‡∏±‡∏î</th></tr></thead><tbody id="env-tbody-npcs"></tbody></table></div>
            </div>
        </div>
    </div>
</div>

<div id="register-dialog-overlay" class="overlay">
    <div class="dialog-window">
        <div class="dialog-title-bar">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</div>
        <div class="dialog-content"><div class="group-box"><div class="group-box-title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div><div class="form-row"><label for="reg-username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</label><input type="text" id="reg-username"></div><div class="form-row"><label for="reg-password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</label><input type="password" id="reg-password"></div></div></div>
        <div class="dialog-buttons">
            <button onclick="handleRegister()">[‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô]</button>
            <button onclick="closeRegisterDialog()">[‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å]</button>
        </div>
    </div>
</div>

<div id="npc-dialog-overlay" class="overlay">
    <div class="dialog-window">
        <div class="dialog-title-bar" id="dialog-title"></div>
        <div class="dialog-content" id="dialog-text"></div>
        <div class="dialog-buttons" id="dialog-buttons-container"></div>
    </div>
</div>

<div id="shop-window" class="overlay">
    <div class="dialog-window">
        <div class="dialog-title-bar" id="shop-title">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</div>
        <div class="dialog-content" id="shop-items-container"></div>
        <div class="dialog-buttons">
            <button onclick="closeShopWindow()">[‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤]</button>
        </div>
    </div>
</div>


<script>
// --- CONSTANTS ---
const ACCOUNTS_STORAGE_KEY = 'ygLightBotAccounts';
const MAX_ACCOUNTS = 5;

// --- YULGANG DATABASE (BASED ON PC TH) ---
const YULGANG_DB = {
    monsters: {
        "1": { name: "‡∏ö‡πá‡∏≠‡∏ö‡πÅ‡∏Ñ‡∏ó", level: 1, hp: 45, exp: 10, atk: 5, def: 1, drops: { '‡∏´‡∏ô‡∏±‡∏á‡∏ö‡πá‡∏≠‡∏ö‡πÅ‡∏Ñ‡∏ó': 0.5, '‡πÄ‡∏á‡∏¥‡∏ô': 0.8 } },
        "2": { name: "‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤", level: 3, hp: 80, exp: 15, atk: 8, def: 2, drops: { '‡∏¢‡∏≤‡πÅ‡∏î‡∏á(‡πÄ‡∏•‡πá‡∏Å)': 0.3, '‡πÄ‡∏á‡∏¥‡∏ô': 0.9, '‡πÄ‡∏Ç‡∏µ‡πâ‡∏¢‡∏ß‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤': 0.25 } },
        "3": { name: "‡∏à‡∏¥‡πâ‡∏á‡∏à‡∏≠‡∏Å‡∏™‡∏≤‡∏°‡∏´‡∏≤‡∏á", level: 4, hp: 100, exp: 18, atk: 10, def: 4, drops: { '‡∏¢‡∏≤‡∏ü‡πâ‡∏≤(‡πÄ‡∏•‡πá‡∏Å)': 0.2, '‡πÄ‡∏á‡∏¥‡∏ô': 1.0, '‡∏´‡∏≤‡∏á‡∏à‡∏¥‡πâ‡∏á‡∏à‡∏≠‡∏Å': 0.2 } },
        "4": { name: "‡∏´‡∏°‡∏π‡∏õ‡πà‡∏≤", level: 5, hp: 120, exp: 20, atk: 12, def: 5, drops: { '‡∏¢‡∏≤‡πÅ‡∏î‡∏á(‡πÄ‡∏•‡πá‡∏Å)': 0.4, '‡πÄ‡∏á‡∏¥‡∏ô': 1.0, '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏°‡∏π‡∏õ‡πà‡∏≤': 0.3 } },
        "5": { name: "‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏î‡∏∏‡∏£‡πâ‡∏≤‡∏¢", level: 8, hp: 180, exp: 40, atk: 20, def: 8, drops: { '‡∏¢‡∏≤‡πÅ‡∏î‡∏á(‡∏Å‡∏•‡∏≤‡∏á)': 0.1, '‡πÄ‡∏á‡∏¥‡∏ô': 1.0, '‡∏Å‡∏£‡∏á‡πÄ‡∏•‡πá‡∏ö‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤': 0.15 } },
        "6": { name: "‡πÇ‡∏à‡∏£‡∏õ‡πà‡∏≤", level: 10, hp: 210, exp: 50, atk: 25, def: 10, drops: { '‡∏¢‡∏≤‡πÅ‡∏î‡∏á(‡∏Å‡∏•‡∏≤‡∏á)': 0.2, '‡πÄ‡∏á‡∏¥‡∏ô': 1.0, '‡∏î‡∏≤‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î': 0.05 } },
    },
    npcs: {
        "1": { id: 1, name: "‡πÄ‡∏í‡πà‡∏≤‡∏¢‡∏≤", title: "‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏≤", location: "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Æ‡∏≠‡∏ô‡∏ö‡∏±‡∏•", x: 150, y: 200, isVendor: true, vendorItems: ["red_pot_s", "blue_pot_s"] },
        "2": { id: 2, name: "‡πÇ‡∏•‡πâ‡∏ô‡πÄ‡∏´‡∏•‡πá‡∏Å‡πÑ‡∏´‡∏•", title: "‡∏ä‡πà‡∏≤‡∏á‡∏ï‡∏µ‡πÄ‡∏´‡∏•‡πá‡∏Å", location: "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Æ‡∏≠‡∏ô‡∏ö‡∏±‡∏•", x: 180, y: 210, isVendor: false },
        "3": { id: 3, name: "‡πÄ‡∏à‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Æ‡∏≠‡∏ô‡∏ö‡∏±‡∏•", title: "‡πÄ‡∏à‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡∏≠‡∏á", location: "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Æ‡∏≠‡∏ô‡∏ö‡∏±‡∏•", x: 200, y: 180, isVendor: false },
    },
    items: {
        "‡∏´‡∏ô‡∏±‡∏á‡∏ö‡πá‡∏≠‡∏ö‡πÅ‡∏Ñ‡∏ó": { name: "‡∏´‡∏ô‡∏±‡∏á‡∏ö‡πá‡∏≠‡∏ö‡πÅ‡∏Ñ‡∏ó", type: "quest" },
        "‡πÄ‡∏Ç‡∏µ‡πâ‡∏¢‡∏ß‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤": { name: "‡πÄ‡∏Ç‡∏µ‡πâ‡∏¢‡∏ß‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤", type: "quest" },
        "‡∏¢‡∏≤‡πÅ‡∏î‡∏á(‡πÄ‡∏•‡πá‡∏Å)": { id: "red_pot_s", name: "‡∏¢‡∏≤‡πÅ‡∏î‡∏á(‡πÄ‡∏•‡πá‡∏Å)", type: "potion", buyPrice: 50 },
        "‡∏¢‡∏≤‡∏ü‡πâ‡∏≤(‡πÄ‡∏•‡πá‡∏Å)": { id: "blue_pot_s", name: "‡∏¢‡∏≤‡∏ü‡πâ‡∏≤(‡πÄ‡∏•‡πá‡∏Å)", type: "potion", buyPrice: 80 },
    },
    quests: {
        "1": { id: 1, title: "‡∏¢‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏í‡πà‡∏≤‡∏¢‡∏≤", npcId: 1, startDialog: "‡πÇ‡∏≠‡πâ‡∏¢... ‡∏õ‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÜ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏π! ‡∏Ç‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ '‡∏´‡∏ô‡∏±‡∏á‡∏ö‡πá‡∏≠‡∏ö‡πÅ‡∏Ñ‡∏ó' 5 ‡∏ä‡∏¥‡πâ‡∏ô ‡∏°‡∏≤‡∏ó‡∏≥‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", completeDialog: "‡πÇ‡∏≠‡πâ! ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Ñ‡∏£‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏ó‡∏µ ‡∏Ç‡∏≠‡∏ö‡πÉ‡∏à‡πÄ‡∏à‡πâ‡∏≤‡∏°‡∏≤‡∏Å ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤", objectives: [{ type: "collect", itemName: "‡∏´‡∏ô‡∏±‡∏á‡∏ö‡πá‡∏≠‡∏ö‡πÅ‡∏Ñ‡∏ó", amount: 5 }], reward: { exp: 100, money: 500 }, status: "available" },
        "2": { id: 2, title: "‡∏®‡∏≤‡∏™‡∏ï‡∏£‡∏≤‡∏ß‡∏∏‡∏ò‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏•‡πá‡∏Å", npcId: 2, startDialog: "‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò‡∏î‡∏µ‡πÜ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‡πÜ! ‡πÑ‡∏õ‡∏´‡∏≤ '‡πÄ‡∏Ç‡∏µ‡πâ‡∏¢‡∏ß‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤' ‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤ 10 ‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≤‡∏à‡∏∞‡∏ó‡∏≥‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏î‡∏π", completeDialog: "‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÄ‡∏Ç‡∏µ‡πâ‡∏¢‡∏ß‡∏û‡∏ß‡∏Å‡∏ô‡∏µ‡πâ‡πÅ‡∏´‡∏•‡∏°‡∏Ñ‡∏°‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏≠‡πâ‡∏≤‡∏ô‡∏µ‡πà‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤", objectives: [{ type: "collect", itemName: "‡πÄ‡∏Ç‡∏µ‡πâ‡∏¢‡∏ß‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤", amount: 10 }], reward: { exp: 250, money: 1000 }, status: "available" }
    },
    skills: {
        "sword_atk_1": { name: "‡πÅ‡∏ó‡∏á‡∏ó‡∏∞‡∏•‡∏ß‡∏á", type: "attack", level: 1, mp_cost: 10, damage_multiplier: 1.1 },
        "sword_buf_1": { id: "speed_buff", name: "‡∏ó‡∏∞‡∏¢‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏µ‡πâ", type: "buff", icon: "üèÉ", level: 1, mp_cost: 20, duration: 180 }
    }
};

const CHARACTER_TEMPLATE = {
    name: "‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏´‡∏±‡∏î‡∏ö‡∏≠‡∏ó", class: "‡∏ô‡∏±‡∏Å‡∏î‡∏≤‡∏ö", level: 1, honor: 0, money: 1000,
    x: 160, y: 190, // Start near town
    hp: 100, maxHp: 100, mp: 50, maxMp: 50, rage: 0, maxRage: 1000, exp: 0, maxExp: 100,
    stats: { atk: 15, acc: 20, def: 5, eva: 5, chi: 5, skill_atk: 5, skill_def: 5, hp_stat: 10 },
    skills: [YULGANG_DB.skills.sword_atk_1, YULGANG_DB.skills.sword_buf_1], 
    inventory: [{ name: '‡∏¢‡∏≤‡πÅ‡∏î‡∏á(‡πÄ‡∏•‡πá‡∏Å)', quantity: 10 }], activeQuests: [], buffs: []
};

// --- APPLICATION STATE ---
let gameState = {};
let gameInterval, buffInterval;

// --- UI SELECTORS ---
const ui = {
    loginScreen: document.getElementById('login-screen'), appScreen: document.getElementById('app-screen'), logArea: document.getElementById('logArea'),
    envTbodyMonsters: document.getElementById('env-tbody-monsters'), envTbodyNpcs: document.getElementById('env-tbody-npcs'),
    itemsTbody: document.querySelector('#items-table tbody'), skillsTbody: document.querySelector('#skills-table tbody'),
    questsList: document.getElementById('quests-list'), loginStatus: document.getElementById('login-status'),
    dialogOverlay: document.getElementById('npc-dialog-overlay'), dialogTitle: document.getElementById('dialog-title'),
    dialogText: document.getElementById('dialog-text'), dialogButtons: document.getElementById('dialog-buttons-container'),
    shopOverlay: document.getElementById('shop-window'), shopTitle: document.getElementById('shop-title'),
    shopItemsContainer: document.getElementById('shop-items-container'), playerDot: document.getElementById('player-dot'),
    buffBar: document.getElementById('buff-bar-main'),
    registerDialog: document.getElementById('register-dialog-overlay'),
    accountSelect: document.getElementById('account-select')
};

// --- ACCOUNT MANAGEMENT ---
function getAccounts() { return JSON.parse(localStorage.getItem(ACCOUNTS_STORAGE_KEY)) || {}; }
function saveAccounts(accounts) { localStorage.setItem(ACCOUNTS_STORAGE_KEY, JSON.stringify(accounts)); }

function showRegisterDialog() { ui.registerDialog.style.display = 'flex'; }
function closeRegisterDialog() { ui.registerDialog.style.display = 'none'; }

function handleRegister() {
    const username = document.getElementById('reg-username').value.trim();
    const password = document.getElementById('reg-password').value;
    const accounts = getAccounts();

    if (!username || !password) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"); return; }
    if (accounts[username]) { alert("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß"); return; }
    if (Object.keys(accounts).length >= MAX_ACCOUNTS) { alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡∏¥‡∏ô ${MAX_ACCOUNTS} ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ`); return; }

    const newCharacterData = JSON.parse(JSON.stringify(CHARACTER_TEMPLATE));
    newCharacterData.name = username; // Use username as character name for simplicity
    
    accounts[username] = { password: password, characterData: newCharacterData };
    saveAccounts(accounts);
    
    alert(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ '${username}' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
    closeRegisterDialog();
    populateAccountList();
}

function handleLogin() {
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    const accounts = getAccounts();
    const account = accounts[username];

    if (account && account.password === password) {
        ui.loginScreen.style.display = 'none';
        ui.appScreen.style.display = 'flex';
        initializeGame(username, account.characterData);
    } else {
        alert("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    }
}

function handleLogout() {
    if (!gameState.loggedIn) return;
    saveCurrentCharacterData();
    gameState.loggedIn = false;
    clearInterval(gameInterval);
    clearInterval(buffInterval);
    
    ui.appScreen.style.display = 'none';
    ui.loginScreen.style.display = 'flex';
    ui.loginStatus.textContent = '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
}

function saveCurrentCharacterData() {
    if (!gameState.loggedIn) return;
    const accounts = getAccounts();
    const username = gameState.character.name;
    if (accounts[username]) {
        accounts[username].characterData = gameState.character;
        saveAccounts(accounts);
        addLog(`[SYSTEM] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ ${username} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'log-system');
    }
}

function populateAccountList() {
    const accounts = getAccounts();
    const usernames = Object.keys(accounts);
    ui.accountSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ --</option>';
    usernames.forEach(username => {
        const option = document.createElement('option');
        option.value = username;
        option.textContent = username;
        ui.accountSelect.appendChild(option);
    });
    ui.loginStatus.textContent = `‡∏û‡∏ö ${usernames.length} ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö`;
}

// --- UI LOGIC ---
function showInfoTab(event, tabName) {
    document.querySelectorAll('.info-tabs .tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.info-tabs .tab-button').forEach(el => el.classList.remove('active'));
    document.getElementById(`tab-${tabName}`).classList.add('active');
    event.target.classList.add('active');
}

function showEnvTab(event, tabName) {
    document.querySelectorAll('#env-tabs ~ .env-area').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('#env-tabs .tab-button').forEach(el => el.classList.remove('active'));
    document.getElementById(`env-${tabName}`).classList.add('active');
    event.target.classList.add('active');
}

function addLog(message, className) {
    if (!ui.logArea) return;
    const timestamp = new Date().toLocaleTimeString('th-TH', { hour12: false });
    const logEntry = document.createElement('div');
    logEntry.className = className;
    logEntry.innerHTML = `[${timestamp}] ${message}`;
    ui.logArea.appendChild(logEntry);
    ui.logArea.scrollTop = ui.logArea.scrollHeight;
}

// --- NPC & SHOP LOGIC ---
function openNpcDialog(npcId) {
    const npc = YULGANG_DB.npcs[npcId];
    if (!npc) return;
    ui.dialogTitle.textContent = npc.name;
    let buttonsHtml = '';
    const completedQuest = gameState.character.activeQuests.find(q => YULGANG_DB.quests[q.id].npcId === npc.id && YULGANG_DB.quests[q.id].status === 'completed');
    if (completedQuest) {
        ui.dialogText.textContent = YULGANG_DB.quests[completedQuest.id].completeDialog;
        buttonsHtml += `<button onclick="turnInQuest(${completedQuest.id})">[‡∏™‡πà‡∏á‡πÄ‡∏Ñ‡∏ß‡∏™]</button>`;
    } else {
        const availableQuest = Object.values(YULGANG_DB.quests).find(q => q.npcId === npc.id && q.status === 'available');
        if (availableQuest) {
            ui.dialogText.textContent = availableQuest.startDialog;
            buttonsHtml += `<button onclick="acceptQuest(${availableQuest.id})">[‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏ß‡∏™]</button>`;
        } else {
            ui.dialogText.textContent = "‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?";
        }
    }
    if (npc.isVendor) { buttonsHtml += `<button onclick="openShopWindow(${npc.id})">[‡∏ã‡∏∑‡πâ‡∏≠/‡∏Ç‡∏≤‡∏¢‡πÑ‡∏≠‡πÄ‡∏ó‡∏°]</button>`; }
    buttonsHtml += `<button onclick="closeNpcDialog()">[‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô]</button>`;
    ui.dialogButtons.innerHTML = buttonsHtml;
    ui.dialogOverlay.style.display = 'flex';
}

function closeNpcDialog() { ui.dialogOverlay.style.display = 'none'; }
function openShopWindow(npcId) {
    const npc = YULGANG_DB.npcs[npcId];
    if (!npc || !npc.isVendor) return;
    closeNpcDialog();
    ui.shopTitle.textContent = `‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á ${npc.name}`;
    ui.shopItemsContainer.innerHTML = npc.vendorItems.map(itemId => {
        const item = Object.values(YULGANG_DB.items).find(i => i.id === itemId);
        return item ? `<div class="shop-item"><span>${item.name}</span><span>‡∏£‡∏≤‡∏Ñ‡∏≤: ${item.buyPrice} ‡∏™‡∏•‡∏∂‡∏á</span><button onclick="buyItem('${item.name}', ${item.buyPrice})">‡∏ã‡∏∑‡πâ‡∏≠</button></div>` : '';
    }).join('');
    ui.shopOverlay.style.display = 'flex';
}
function closeShopWindow() { ui.shopOverlay.style.display = 'none'; }
function buyItem(itemName, price) {
    if (gameState.character.money >= price) {
        gameState.character.money -= price;
        addItemToInventory(itemName, 1);
        addLog(`‡∏ã‡∏∑‡πâ‡∏≠ ${itemName} 1 ‡∏ä‡∏¥‡πâ‡∏ô ‡πÉ‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ ${price} ‡∏™‡∏•‡∏∂‡∏á`, 'log-item');
        updateUI();
    } else {
        addLog(`‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠ ${itemName}`, 'log-error');
    }
}

// --- QUEST LOGIC ---
function acceptQuest(questId) {
    const quest = YULGANG_DB.quests[questId];
    if (!quest || quest.status !== 'available') return;
    quest.status = 'active';
    const questData = { id: quest.id, title: quest.title, objectives: JSON.parse(JSON.stringify(quest.objectives)), progress: {} };
    questData.objectives.forEach(obj => { if (obj.type === 'collect') { questData.progress[obj.itemName] = 0; } });
    gameState.character.activeQuests.push(questData);
    addLog(`‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡∏°‡πà: ${quest.title}`, 'log-quest');
    closeNpcDialog(); updateUI();
}

function turnInQuest(questId) {
    const questIndex = gameState.character.activeQuests.findIndex(q => q.id === questId);
    if (questIndex === -1) return;
    const questData = gameState.character.activeQuests[questIndex];
    const dbQuest = YULGANG_DB.quests[questId];
    questData.objectives.forEach(obj => { if (obj.type === 'collect') { removeItemFromInventory(obj.itemName, obj.amount); } });
    const reward = dbQuest.reward;
    gameState.character.exp += reward.exp;
    gameState.character.money += reward.money;
    addLog(`‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ${dbQuest.title}! ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö EXP +${reward.exp}, ‡πÄ‡∏á‡∏¥‡∏ô +${reward.money}`, 'log-exp');
    gameState.character.activeQuests.splice(questIndex, 1);
    dbQuest.status = 'done';
    checkLevelUp(); closeNpcDialog(); updateUI();
}

function updateQuestProgress(itemName) {
    gameState.character.activeQuests.forEach(quest => {
        const dbQuest = YULGANG_DB.quests[quest.id];
        if (dbQuest.status !== 'active') return;
        quest.objectives.forEach(obj => {
            if (obj.type === 'collect' && obj.itemName === itemName) {
                if (quest.progress[itemName] < obj.amount) {
                    quest.progress[itemName]++;
                    addLog(`[‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à] ‡πÄ‡∏Å‡πá‡∏ö ${itemName} (${quest.progress[itemName]}/${obj.amount})`, 'log-quest');
                    checkQuestCompletion(quest);
                }
            }
        });
    });
}

function checkQuestCompletion(quest) {
    const isCompleted = quest.objectives.every(obj => (obj.type === 'collect') ? quest.progress[obj.itemName] >= obj.amount : true);
    if (isCompleted) {
        const dbQuest = YULGANG_DB.quests[quest.id];
        if(dbQuest.status === 'active') {
            dbQuest.status = 'completed';
            addLog(`[‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à] ${quest.title} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö ${YULGANG_DB.npcs[dbQuest.npcId].name}`, 'log-quest');
        }
    }
}

// --- GAME LOGIC ---
function initializeGame(username, characterData) {
    gameState = {
        loggedIn: true, autoHunt: false, autoPotion: false, autoPickup: false, autoBuff: false, targetId: null, isMoving: false,
        character: JSON.parse(JSON.stringify(characterData)), // Load specific character data
        environment: { monsters: [], npcs: [] }
    };
    let monsterIdCounter = 1;
    const monsterKeys = Object.keys(YULGANG_DB.monsters);
    for(let i=0; i<10; i++) {
        const key = monsterKeys[Math.floor(Math.random() * monsterKeys.length)];
        gameState.environment.monsters.push({
            id: monsterIdCounter++, dbId: key, currentHp: YULGANG_DB.monsters[key].hp,
            x: Math.floor(Math.random() * 450), y: Math.floor(Math.random() * 240)
        });
    }
    gameState.environment.npcs = Object.values(YULGANG_DB.npcs);
    Object.values(YULGANG_DB.quests).forEach(q => q.status = 'available');
    
    // Sync quest status with loaded character data
    gameState.character.activeQuests.forEach(activeQuest => {
        if (YULGANG_DB.quests[activeQuest.id]) {
            YULGANG_DB.quests[activeQuest.id].status = 'active';
            checkQuestCompletion(activeQuest); // Re-check status in case it was completed before logout
        }
    });

    addLog(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, ${username}!`, 'log-exp');
    document.getElementById('char-name').value = username;
    
    // Reset control checkboxes
    ['auto-hunt-check', 'auto-pot-check', 'auto-pickup-check', 'auto-buff-check'].forEach(id => document.getElementById(id).checked = false);

    gameInterval = setInterval(gameLoop, 2000);
    buffInterval = setInterval(() => { if(gameState.loggedIn) handleBuffs() }, 1000);
    updateUI();
}

function resetGame() { 
    gameState = {}; 
    clearInterval(gameInterval);
    clearInterval(buffInterval);
    updateUI(); 
}

function gameLoop() {
    if (!gameState.loggedIn || !gameState.autoHunt || gameState.isMoving) return;
    if (gameState.targetId === null) { findNewTarget(); }
    const target = gameState.environment.monsters.find(m => m.id === gameState.targetId);
    if (!target || target.currentHp <= 0) { gameState.targetId = null; return; }
    const dist = Math.hypot(target.x - gameState.character.x, target.y - gameState.character.y);
    if (dist > 50) { moveTo(target.x, target.y); } 
    else { attackTarget(target); }
}

function handleBuffs() {
    if(gameState.autoBuff) {
        const buffSkill = gameState.character.skills.find(s => s.type === 'buff');
        if (buffSkill && !gameState.character.buffs.some(b => b.id === buffSkill.id)) {
            if (gameState.character.mp >= buffSkill.mp_cost) {
                gameState.character.mp -= buffSkill.mp_cost;
                gameState.character.buffs.push({ id: buffSkill.id, name: buffSkill.name, icon: buffSkill.icon, timeLeft: buffSkill.duration });
                addLog(`‡πÉ‡∏ä‡πâ‡∏™‡∏Å‡∏¥‡∏•‡∏ö‡∏±‡∏ü [${buffSkill.name}]`, 'log-skill');
            }
        }
    }
    gameState.character.buffs.forEach((buff, index) => {
        buff.timeLeft--;
        if (buff.timeLeft <= 0) {
            gameState.character.buffs.splice(index, 1);
            addLog(`‡∏ö‡∏±‡∏ü [${buff.name}] ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤`, 'log-info');
        }
    });
    updateUI();
}

function findNewTarget() {
    const availableTargets = gameState.environment.monsters.filter(m => m.currentHp > 0);
    if (availableTargets.length > 0) {
        availableTargets.sort((a,b) => Math.hypot(a.x - gameState.character.x, a.y - gameState.character.y) - Math.hypot(b.x - gameState.character.x, b.y - gameState.character.y));
        gameState.targetId = availableTargets[0].id;
        const targetInfo = YULGANG_DB.monsters[availableTargets[0].dbId];
        addLog(`‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${targetInfo.name} ‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏Å‡∏±‡∏î [${availableTargets[0].x}, ${availableTargets[0].y}]`, 'log-info');
    }
}

function moveTo(x, y) {
    gameState.isMoving = true;
    addLog(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á [${x}, ${y}]...`, 'log-info');
    setTimeout(() => {
        gameState.character.x = x + (Math.random() * 20 - 10);
        gameState.character.y = y + (Math.random() * 20 - 10);
        gameState.isMoving = false;
        addLog(`‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô [${Math.floor(gameState.character.x)}, ${Math.floor(gameState.character.y)}]`, 'log-info');
        updateUI();
    }, 1500);
}

function returnToTown() {
    if (!gameState.loggedIn) return;
    addLog(`‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏ô‡∏ï‡πå‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡∏≠‡∏á...`, 'log-system');
    moveTo(160, 190);
    gameState.character.hp = gameState.character.maxHp;
    gameState.character.mp = gameState.character.maxMp;
    addLog(`‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏û‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏≤‡∏ì‡πÄ‡∏ï‡πá‡∏°`, 'log-system');
    updateUI();
}

function attackTarget(target) {
    const targetInfo = YULGANG_DB.monsters[target.dbId];
    let damage = Math.max(1, Math.floor(gameState.character.stats.atk + (Math.random() * 5) - targetInfo.def));
    target.currentHp = Math.max(0, target.currentHp - damage);
    addLog(`‡πÇ‡∏à‡∏°‡∏ï‡∏µ ${targetInfo.name}, ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ ${damage} ‡∏´‡∏ô‡πà‡∏ß‡∏¢ (HP: ${target.currentHp}/${targetInfo.hp})`, 'log-attack');
    
    if (target.currentHp <= 0) { handleMonsterDefeat(target); } 
    else {
        setTimeout(() => {
             if(target.currentHp <= 0) return;
             const monsterDamage = Math.max(1, Math.floor(targetInfo.atk - (gameState.character.stats.def/2)));
             gameState.character.hp = Math.max(0, gameState.character.hp - monsterDamage);
             addLog(`${targetInfo.name} ‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö, ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ ${monsterDamage} ‡∏´‡∏ô‡πà‡∏ß‡∏¢`, 'log-error');
        }, 500);
    }
    
    if (gameState.autoPotion && (gameState.character.hp / gameState.character.maxHp < 0.6)) {
        gameState.character.hp = Math.min(gameState.character.maxHp, gameState.character.hp + 50);
        addLog(`‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡πÅ‡∏î‡∏á(‡πÄ‡∏•‡πá‡∏Å), ‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï 50 ‡∏´‡∏ô‡πà‡∏ß‡∏¢`, 'log-system');
    }
    updateUI();
}

function handleMonsterDefeat(target) {
    const targetInfo = YULGANG_DB.monsters[target.dbId];
    addLog(`‡∏Å‡∏≥‡∏à‡∏±‡∏î ${targetInfo.name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'log-exp');
    gameState.character.exp += targetInfo.exp;
    addLog(`‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå ${targetInfo.exp} ‡∏´‡∏ô‡πà‡∏ß‡∏¢`, 'log-exp');
    
    if (gameState.autoPickup && targetInfo.drops) {
        for (const itemName in targetInfo.drops) {
            if (Math.random() < targetInfo.drops[itemName]) {
                if (itemName === '‡πÄ‡∏á‡∏¥‡∏ô') {
                    const amount = 10 + Math.floor(Math.random() * targetInfo.level * 10);
                    gameState.character.money += amount;
                    addLog(`‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${amount.toLocaleString()} ‡∏™‡∏•‡∏∂‡∏á`, 'log-item');
                } else {
                    addItemToInventory(itemName, 1);
                    addLog(`‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏≠‡πÄ‡∏ó‡∏°: ${itemName}`, 'log-item');
                    updateQuestProgress(itemName);
                }
            }
        }
    }
    
    checkLevelUp();
    gameState.targetId = null;

    setTimeout(() => {
         const monsterIndex = gameState.environment.monsters.findIndex(m => m.id === target.id);
         if(monsterIndex !== -1){
             gameState.environment.monsters[monsterIndex].currentHp = targetInfo.hp;
             gameState.environment.monsters[monsterIndex].x = Math.floor(Math.random() * 450);
             gameState.environment.monsters[monsterIndex].y = Math.floor(Math.random() * 240);
             addLog(`${targetInfo.name} ‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏µ‡πà [${gameState.environment.monsters[monsterIndex].x}, ${gameState.environment.monsters[monsterIndex].y}]`, 'log-system');
             updateUI();
         }
    }, 5000);
}

function addItemToInventory(name, quantity) {
    const existingItem = gameState.character.inventory.find(item => item.name === name);
    if (existingItem) { existingItem.quantity += quantity; } else { gameState.character.inventory.push({ name, quantity }); }
}

function removeItemFromInventory(name, quantity) {
    const itemIndex = gameState.character.inventory.findIndex(item => item.name === name);
    if (itemIndex > -1) {
        gameState.character.inventory[itemIndex].quantity -= quantity;
        if (gameState.character.inventory[itemIndex].quantity <= 0) {
            gameState.character.inventory.splice(itemIndex, 1);
        }
    }
}

function checkLevelUp() {
    if (gameState.character.exp >= gameState.character.maxExp) {
        gameState.character.level++;
        gameState.character.exp -= gameState.character.maxExp;
        gameState.character.maxExp = Math.floor(gameState.character.maxExp * 1.5);
        gameState.character.maxHp += 20;
        gameState.character.maxMp += 10;
        gameState.character.hp = gameState.character.maxHp;
        gameState.character.mp = gameState.character.maxMp;
        addLog(`‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏≠‡∏±‡∏û! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á‡πÄ‡∏•‡πÄ‡∏ß‡∏• ${gameState.character.level} ‡πÅ‡∏•‡πâ‡∏ß!`, 'log-exp');
    }
}

// --- UI UPDATE FUNCTION ---
function updateUI() {
    if (!gameState.loggedIn) { return; };
    const char = gameState.character;
    const fields = {
        'info-name': char.name, 'info-class': char.class, 'info-level': char.level, 'info-coords': `${Math.floor(char.x)}, ${Math.floor(char.y)}`, 'info-money': char.money.toLocaleString(),
        'hp-text': `${char.hp}/${char.maxHp}`, 'mp-text': `${char.mp}/${char.maxMp}`, 'rage-text': `${char.rage}/${char.maxRage}`, 'exp-text': `${char.exp}/${char.maxExp}`,
        'stat-atk': char.stats.atk, 'stat-acc': char.stats.acc, 'stat-def': char.stats.def, 'stat-eva': char.stats.eva, 'stat-chi': char.stats.chi, 'stat-skill-atk': char.stats.skill_atk, 'stat-skill-def': char.stats.skill_def, 'stat-hp': char.stats.hp_stat
    };
    for(const id in fields) { if(document.getElementById(id)) document.getElementById(id).textContent = fields[id]; }

    const bars = { 'hp-bar-top': (char.hp / char.maxHp), 'mp-bar-top': (char.mp / char.maxMp), 'exp-bar-top': (char.exp / char.maxExp), 'hp-bar-main': (char.hp / char.maxHp), 'mp-bar-main': (char.mp / char.maxMp), 'exp-bar-main': (char.exp / char.maxExp), 'rage-bar-main': (char.rage / char.maxRage) };
    for(const id in bars) { document.getElementById(id).style.width = `${bars[id] * 100}%`; }
    document.getElementById('hp-percent-top').textContent = `${Math.floor(bars['hp-bar-top']*100)}%`;
    document.getElementById('mp-percent-top').textContent = `${Math.floor(bars['mp-bar-top']*100)}%`;
    document.getElementById('exp-percent-top').textContent = `${Math.floor(bars['exp-bar-top']*100)}%`;
    document.getElementById('stat-lv-top').textContent = char.level;


    ui.envTbodyMonsters.innerHTML = gameState.environment.monsters.map(mob => { const info = YULGANG_DB.monsters[mob.dbId]; const status = mob.currentHp > 0 ? `${mob.currentHp}/${info.hp}` : '‡∏ï‡∏≤‡∏¢'; return `<tr class="${mob.id === gameState.targetId ? 'targeted' : ''}"><td>${mob.id}</td><td>${info.name}</td><td>${mob.x},${mob.y}</td><td>${info.level}</td><td>${status}</td></tr>`; }).join('');
    ui.envTbodyNpcs.innerHTML = gameState.environment.npcs.map(npc => `<tr class="clickable" onclick="openNpcDialog(${npc.id})"><td>${npc.id}</td><td>${npc.name}</td><td>${npc.location}</td><td>${npc.x},${npc.y}</td></tr>`).join('');
    ui.itemsTbody.innerHTML = char.inventory.map(item => `<tr><td>${item.name}</td><td>${item.quantity.toLocaleString()}</td></tr>`).join('');
    ui.skillsTbody.innerHTML = char.skills.map(skill => `<tr><td>${skill.name}</td><td>${skill.type}</td><td>${skill.mp_cost}</td></tr>`).join('');
    ui.questsList.innerHTML = char.activeQuests.map(q => { let p = q.objectives.map(obj => (obj.type === 'collect') ? `<li>${obj.itemName}: ${q.progress[obj.itemName]} / ${obj.amount}</li>` : '').join(''); return `<div class="group-box" style="font-size:10px;"><div class="group-box-title">${q.title}</div><ul>${p}</ul></div>`; }).join('');
    
    ui.playerDot.style.left = `${(char.x / 480) * 100}%`;
    ui.playerDot.style.top = `${(char.y / 250) * 100}%`;

    ui.buffBar.innerHTML = char.buffs.map(b => `<div class="buff-icon">${b.icon}<span class="tooltip">${b.name} (${b.timeLeft}s)</span></div>`).join('');
}

// --- INITIALIZATION ---
window.onload = () => {
    populateAccountList();
    ui.accountSelect.addEventListener('change', (e) => {
        document.getElementById('login-username').value = e.target.value;
    });

    document.getElementById('auto-hunt-check').addEventListener('change', (e) => { if(gameState.loggedIn) gameState.autoHunt = e.target.checked; addLog(`‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πà‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ${e.target.checked ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}`, 'log-system'); });
    document.getElementById('auto-pot-check').addEventListener('change', (e) => { if(gameState.loggedIn) gameState.autoPotion = e.target.checked; addLog(`‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ${e.target.checked ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}`, 'log-system'); });
    document.getElementById('auto-pickup-check').addEventListener('change', (e) => { if(gameState.loggedIn) gameState.autoPickup = e.target.checked; addLog(`‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ${e.target.checked ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}`, 'log-system'); });
    document.getElementById('auto-buff-check').addEventListener('change', (e) => { if(gameState.loggedIn) gameState.autoBuff = e.target.checked; addLog(`‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏û‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ${e.target.checked ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}`, 'log-system'); });
};
</script>
</body>
</html>
